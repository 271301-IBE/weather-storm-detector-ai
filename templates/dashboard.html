{% extends "base.html" %}

{% block title %}Weather Storm Detection - Dashboard{% endblock %}

{% block content %}
<div id="dashboard-content">
    <!-- ƒåHM√ö Warnings - Full Width at Top -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚ö†Ô∏è ƒåHM√ö Meteorologick√° Varov√°n√≠ - Brno</h5>
                </div>
                <div class="card-body" id="chmiWarnings">
                    <p class="text-center">Loading warnings...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Aktu√°ln√≠ poƒças√≠ üå§Ô∏è</div>
                <div class="card-body" id="currentWeather">
                    <p class="text-center">Loading weather data...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Statistiky syst√©mu (24 h) üìä</div>
                <div class="card-body" id="systemStats">
                    <p class="text-center">Loading statistics...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">P≈ô√≠≈°t√≠ predikce bou≈ôky ‚õàÔ∏è</div>
                <div class="card-body" id="nextStormPrediction">
                    <p class="text-center">Loading prediction...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mt-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Statistika blesk≈Ø ‚ö°</span>
                    <div class="btn-group">
                        <a href="/map" class="btn btn-sm btn-outline-primary">Otev≈ô√≠t mapu</a>
                        <a href="/map" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary">Nov√° z√°lo≈æka</a>
                    </div>
                </div>
                <div class="card-body" id="lightningStats">
                    <p class="text-center">Loading lightning stats...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mt-4">
            <div class="card">
                <div class="card-header">Stav syst√©mu üíª</div>
                <div class="card-body" id="systemStatus">
                    <p class="text-center">Loading system status...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Ned√°vn√© anal√Ωzy AI ü§ñ</div>
                <div class="card-body" id="recentAnalysis">
                    <p class="text-center">Loading analysis data...</p>
                </div>
            </div>
        </div>
        
        <!-- New: Test Alert & Threshold Controls -->
        <div class="col-lg-12 mt-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>N√°stroje v√Ωstrah a p≈ôesnost</span>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="stormThreshold" class="form-label">Prahov√° hodnota jistoty bou≈ôky (0‚Äì1)</label>
                            <div class="input-group">
                                <input type="number" step="0.01" min="0" max="1" class="form-control" id="stormThreshold" placeholder="0.99" />
                                <button class="btn btn-outline-primary" id="saveThresholdBtn">Ulo≈æit</button>
                            </div>
                            <small class="text-muted">Ladƒõn√≠ okam≈æiku odesl√°n√≠ v√Ωstrah (podle ROC/PR).</small>
                            <div id="thresholdStatus" class="small mt-1"></div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning" id="sendTestAlertBtn">Odeslat testovac√≠ e‚Äëmail v√Ωstrahy</button>
                            <div id="testAlertStatus" class="small mt-2"></div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary" id="sendTestTelegramBtn">Odeslat testovac√≠ Telegram</button>
                            <div id="testTelegramStatus" class="small mt-2"></div>
                        </div>
                    </div>

                    <!-- ROC/PR placeholders -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="mb-2">ROC k≈ôivka <span class="text-muted small" id="rocMeta"></span></h6>
                            <div class="chart-compact-container">
                                <canvas id="rocChart" class="chart-compact"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">PR k≈ôivka <span class="text-muted small" id="prMeta"></span></h6>
                            <div class="chart-compact-container">
                                <canvas id="prChart" class="chart-compact"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <label class="input-group-text" for="autoTuneObjective">C√≠l</label>
                                <select id="autoTuneObjective" class="form-select">
                                    <option value="f1" selected>Maximalizovat F1</option>
                                    <option value="recall">Minimalizovat false negatives</option>
                                    <option value="precision">Minimalizovat false alarms</option>
                                </select>
                                <button class="btn btn-success" id="autoTuneBtn">Auto‚Äëtune pr√°h</button>
                            </div>
                            <div id="autoTuneStatus" class="small mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <!-- SNOW section moved under main dashboard content -->
    <div class="row mt-4" id="snow">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Sn√≠h a mr√°z ‚ùÑÔ∏è</div>
                <div class="card-body" id="snowSummary">
                    <p class="text-center">Loading snow & frost info...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Data sources status -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Datov√© zdroje ‚õÖ</div>
                <div class="card-body" id="sourceStatus">
                    <p class="text-center">Naƒç√≠t√°m stav zdroj≈Ø‚Ä¶</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Weather Trends (24h) üìà</span>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-danger btn-sm" onclick="reportStormEvent('storm_now')">
                                ‚õàÔ∏è Bou≈ôka nyn√≠
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="reportStormEvent('rain_now')">
                                üåßÔ∏è D√©≈°≈• nyn√≠
                            </button>
                            <button type="button" class="btn btn-success btn-sm" onclick="reportStormEvent('no_storm')">
                                ‚òÄÔ∏è Bez bou≈ôe
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body chart-container">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            
            <div class="card mt-4">
                <div class="card-header">Recent Emails üìß</div>
                <div class="card-body" id="recentEmails">
                    <p class="text-center">Loading email history...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Next 6 Hours Forecast üîÆ</span>
                        <div>
                            <span class="badge bg-info me-2" id="forecastMethod">Naƒç√≠t√°m‚Ä¶</span>
                            <span class="badge bg-secondary" id="forecastConfidence">Jistota: --</span>
                            <small class="text-muted ms-2" id="forecastLastUpdated">Aktualizov√°no: --</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Method Selector Tabs -->
                    <ul class="nav nav-tabs mb-3" id="forecastTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ensemble-tab" data-bs-toggle="tab" data-bs-target="#ensemble-pane" type="button" role="tab">
                                üéØ Ensemble (Best)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-pane" type="button" role="tab">
                                ü§ñ AI Prediction
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="physics-tab" data-bs-toggle="tab" data-bs-target="#physics-pane" type="button" role="tab">
                                üßÆ Local Physics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison-pane" type="button" role="tab">
                                üìä Compare All
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="forecastTabContent">
                        <!-- Ensemble Forecast -->
                        <div class="tab-pane fade show active" id="ensemble-pane" role="tabpanel">
                            <div class="alert alert-success" role="alert">
                                <strong>üéØ Ensemble p≈ôedpovƒõƒè:</strong> Kombinace AI, fyzik√°ln√≠ch model≈Ø a uƒçen√≠ pro nejlep≈°√≠ odhad
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm table-balanced table-sticky">
                                    <thead class="table-success">
                                        <tr>
                                            <th class="nowrap col-w-xs">ƒåas</th>
                                            <th class="text-end col-w-xs">Teplota (¬∞C)</th>
                                            <th class="text-end col-w-xs">Vlhkost (%)</th>
                                            <th class="text-end col-w-sm">Tlak (hPa)</th>
                                            <th class="text-end col-w-xs">V√≠tr (m/s)</th>
                                            <th class="text-end col-w-xs">Sr√°≈æky (mm)</th>
                                            <th class="text-end col-w-sm">Pravdƒõp. sr√°≈æek (%)</th>
                                            <th class="col-w-md">Stav</th>
                                            <th class="text-end col-w-sm">Jistota <span title="Jistota = odhadovan√° pravdƒõpodobnost jevu pro dan√Ω ƒçasov√Ω krok">‚ÑπÔ∏è</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ensembleForecastBody">
                                        {% if forecast_data and forecast_data.ensemble and forecast_data.ensemble.forecast %}
                                            {% for item in forecast_data.ensemble.forecast %}
                                            <tr>
                                                <td class="nowrap"><strong>{{ item.timestamp }}</strong></td>
                                                <td class="text-end">{{ item.temperature }}¬∞C</td>
                                                <td class="text-end">{{ item.humidity }}%</td>
                                                <td class="text-end">{{ item.pressure }}</td>
                                                <td class="text-end">{{ item.wind_speed }}</td>
                                                <td class="text-end">{{ item.precipitation }}</td>
                                                <td class="text-end">{{ item.precipitation_probability }}%</td>
                                                <td class="nowrap">
                                                    <span class="badge bg-light text-dark">{{ item.condition }}</span>
                                                </td>
                                                <td class="text-end"><span class="badge bg-success">{{ item.confidence }}%</span> <span class="badge bg-secondary">{{ item.confidence_level }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center">No forecast data available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- AI Forecast -->
                        <div class="tab-pane fade" id="ai-pane" role="tabpanel">
                            <div class="alert alert-info" role="alert">
                                <strong>ü§ñ P≈ôedpovƒõƒè AI:</strong> Anal√Ωza AI na z√°kladƒõ vzor≈Ø v datech a aktu√°ln√≠ch podm√≠nek
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm table-balanced table-sticky">
                                    <thead class="table-info">
                                        <tr>
                                            <th class="nowrap col-w-xs">ƒåas</th>
                                            <th class="text-end col-w-xs">Teplota (¬∞C)</th>
                                            <th class="text-end col-w-xs">Vlhkost (%)</th>
                                            <th class="text-end col-w-sm">Tlak (hPa)</th>
                                            <th class="text-end col-w-xs">V√≠tr (m/s)</th>
                                            <th class="text-end col-w-xs">Sr√°≈æky (mm)</th>
                                            <th class="text-end col-w-sm">Pravdƒõp. sr√°≈æek (%)</th>
                                            <th class="col-w-md">Stav</th>
                                            <th class="text-end col-w-sm">Jistota <span title="Jistota = odhadovan√° pravdƒõpodobnost jevu pro dan√Ω ƒçasov√Ω krok">‚ÑπÔ∏è</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="aiForecastBody">
                                        {% if forecast_data and forecast_data.ai and forecast_data.ai.forecast %}
                                            {% for item in forecast_data.ai.forecast %}
                                            <tr>
                                                <td class="nowrap"><strong>{{ item.timestamp }}</strong></td>
                                                <td class="text-end">{{ item.temperature }}¬∞C</td>
                                                <td class="text-end">{{ item.humidity }}%</td>
                                                <td class="text-end">{{ item.pressure }}</td>
                                                <td class="text-end">{{ item.wind_speed }}</td>
                                                <td class="text-end">{{ item.precipitation }}</td>
                                                <td class="text-end">{{ item.precipitation_probability }}%</td>
                                                <td class="nowrap">
                                                    <span class="badge bg-light text-dark">{{ item.condition }}</span>
                                                </td>
                                                <td class="text-end"><span class="badge bg-info">{{ item.confidence }}%</span> <span class="badge bg-secondary">{{ item.confidence_level }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center">No forecast data available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Physics Forecast -->
                        <div class="tab-pane fade" id="physics-pane" role="tabpanel">
                            <div class="alert alert-warning" role="alert">
                                <strong>üßÆ Lok√°ln√≠ fyzika:</strong> V√Ωpoƒçty fyziky atmosf√©ry a anal√Ωza trend≈Ø
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm table-balanced table-sticky">
                                    <thead class="table-warning">
                                        <tr>
                                            <th class="nowrap col-w-xs">ƒåas</th>
                                            <th class="text-end col-w-xs">Teplota (¬∞C)</th>
                                            <th class="text-end col-w-xs">Vlhkost (%)</th>
                                            <th class="text-end col-w-sm">Tlak (hPa)</th>
                                            <th class="text-end col-w-xs">V√≠tr (m/s)</th>
                                            <th class="text-end col-w-xs">Sr√°≈æky (mm)</th>
                                            <th class="text-end col-w-sm">Pravdƒõp. sr√°≈æek (%)</th>
                                            <th class="col-w-md">Stav</th>
                                            <th class="text-end col-w-sm">Jistota <span title="Jistota = odhadovan√° pravdƒõpodobnost jevu pro dan√Ω ƒçasov√Ω krok">‚ÑπÔ∏è</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="physicsForecastBody">
                                        {% if forecast_data and forecast_data.physics and forecast_data.physics.forecast %}
                                            {% for item in forecast_data.physics.forecast %}
                                            <tr>
                                                <td class="nowrap"><strong>{{ item.timestamp }}</strong></td>
                                                <td class="text-end">{{ item.temperature }}¬∞C</td>
                                                <td class="text-end">{{ item.humidity }}%</td>
                                                <td class="text-end">{{ item.pressure }}</td>
                                                <td class="text-end">{{ item.wind_speed }}</td>
                                                <td class="text-end">{{ item.precipitation }}</td>
                                                <td class="text-end">{{ item.precipitation_probability }}%</td>
                                                <td class="nowrap">
                                                    <span class="badge bg-light text-dark">{{ item.condition }}</span>
                                                </td>
                                                <td class="text-end"><span class="badge bg-warning">{{ item.confidence }}%</span> <span class="badge bg-secondary">{{ item.confidence_level }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center">No forecast data available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Comparison View -->
                        <div class="tab-pane fade" id="comparison-pane" role="tabpanel">
                            <div class="alert alert-secondary" role="alert">
                                <strong>üìä Method Comparison:</strong> Side-by-side comparison of all forecasting approaches
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm table-balanced table-sticky">
                                    <thead class="table-dark">
                                        <tr>
                                            <th rowspan="2" class="nowrap col-w-xs">Time</th>
                                            <th colspan="3" class="text-center">Temperature (¬∞C)</th>
                                            <th colspan="3" class="text-center">Humidity (%)</th>
                                            <th colspan="3" class="text-center">Pressure (hPa)</th>
                                        </tr>
                                        <tr>
                                            <th class="text-success">Ensemble</th>
                                            <th class="text-info">AI</th>
                                            <th class="text-warning">Physics</th>
                                            <th class="text-success">Ensemble</th>
                                            <th class="text-info">AI</th>
                                            <th class="text-warning">Physics</th>
                                            <th class="text-success">Ensemble</th>
                                            <th class="text-info">AI</th>
                                            <th class="text-warning">Physics</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonForecastBody">
                                        {% if forecast_data and forecast_data.ensemble and forecast_data.ensemble.forecast %}
                                            {% for i in range(forecast_data.ensemble.forecast|length) %}
                                            <tr>
                                                <td class="nowrap"><strong>{{ forecast_data.ensemble.forecast[i].timestamp }}</strong></td>
                                                <td class="text-end text-success">{{ forecast_data.ensemble.forecast[i].temperature if forecast_data.ensemble else '--' }}</td>
                                                <td class="text-end text-info">{{ forecast_data.ai.forecast[i].temperature if forecast_data.ai else '--' }}</td>
                                                <td class="text-end text-warning">{{ forecast_data.physics.forecast[i].temperature if forecast_data.physics else '--' }}</td>
                                                <td class="text-end text-success">{{ forecast_data.ensemble.forecast[i].humidity if forecast_data.ensemble else '--' }}</td>
                                                <td class="text-end text-info">{{ forecast_data.ai.forecast[i].humidity if forecast_data.ai else '--' }}</td>
                                                <td class="text-end text-warning">{{ forecast_data.physics.forecast[i].humidity if forecast_data.physics else '--' }}</td>
                                                <td class="text-end text-success">{{ forecast_data.ensemble.forecast[i].pressure if forecast_data.ensemble else '--' }}</td>
                                                <td class="text-end text-info">{{ forecast_data.ai.forecast[i].pressure if forecast_data.ai else '--' }}</td>
                                                <td class="text-end text-warning">{{ forecast_data.physics.forecast[i].pressure if forecast_data.physics else '--' }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="10" class="text-center">No comparison data available</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Forecast Metadata -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-1">üîç Method Details</h6>
                                    <div id="methodDetails">
                                        <small class="text-muted">Select a forecast method to see details</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-1">üìà Accuracy Stats</h6>
                                    <div id="accuracyStats">
                                        <small class="text-muted">Recent forecast accuracy information</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Vyu≈æit√≠ API üîó</div>
                <div class="card-body" id="apiUsageStats">
                    <p class="text-center">Loading API usage...</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Combined Weather Data ‚öñÔ∏è</div>
                <div class="card-body" id="weatherAverages">
                    <p class="text-center">Loading averages...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="history-content" style="display:none;">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Historical Weather Data üï∞Ô∏è</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="historyTimeline" class="form-label">Select Timeline:</label>
                        <select class="form-select" id="historyTimeline">
                            <option value="24">Last 24 Hours</option>
                            <option value="72">Last 3 Days</option>
                            <option value="168">Last 7 Days</option>
                            <option value="720">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartTemperature"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartHumidity"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartPressure"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartWindSpeed"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartPrecipitation"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="history-chart-container">
                                <canvas id="historyChartPrecipitationProbability"></canvas>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="history-chart-container">
                                <canvas id="historyChartCombined"></canvas>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="history-chart-container">
                                <canvas id="historyChartWindPrecipitation"></canvas>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="history-chart-container">
                                <canvas id="historyChartPrecipitationProbabilityCombined"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Register Chart.js plugins
    Chart.register(window['chartjs-plugin-annotation']);
    
    let weatherChart;
    const historyCharts = {}; // Object to store multiple history chart instances
    
    // Auto-refresh data every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Load all data on page load
    window.onload = function() {
        loadDashboardData();
        showTab('dashboard'); // Default to dashboard tab

        // Event listeners for history panel
        document.getElementById('historyTimeline').addEventListener('change', loadAllHistoryCharts);

        // Load current threshold
        fetch('/api/current_threshold').then(r=>r.json()).then(d=>{
            if (d && d.storm_confidence_threshold !== undefined) {
                document.getElementById('stormThreshold').value = d.storm_confidence_threshold;
            }
        }).catch(()=>{});

        // Save threshold
        const saveBtn = document.getElementById('saveThresholdBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                const v = parseFloat(document.getElementById('stormThreshold').value);
                fetch('/api/set_threshold', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ storm_confidence_threshold: v }) })
                    .then(r=>r.json()).then(d=>{
                        const el = document.getElementById('thresholdStatus');
                        if (d.success) { el.innerHTML = '<span class="text-success">Saved.</span>'; }
                        else { el.innerHTML = `<span class=\"text-danger\">${d.error||'Failed'}</span>`; }
                    }).catch(()=>{ document.getElementById('thresholdStatus').innerHTML = '<span class="text-danger">Error</span>'; });
            });
        }

        const autoBtn = document.getElementById('autoTuneBtn');
        if (autoBtn) {
            autoBtn.addEventListener('click', () => {
                const objective = document.getElementById('autoTuneObjective').value;
                fetch('/api/auto_tune_threshold', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ objective }) })
                    .then(r=>r.json()).then(d=>{
                        const el = document.getElementById('autoTuneStatus');
                        if (d.success) {
                            document.getElementById('stormThreshold').value = d.threshold?.toFixed?.(2) ?? d.threshold;
                            el.innerHTML = `<span class="text-success">Nov√Ω pr√°h: ${d.threshold}</span>`;
                        } else {
                            el.innerHTML = `<span class="text-danger">${d.error||'Nepoda≈ôilo se naladit pr√°h'}</span>`;
                        }
                    }).catch(()=>{ document.getElementById('autoTuneStatus').innerHTML = '<span class="text-danger">Chyba komunikace</span>'; });
            });
        }

        // Send test alert
        const testBtn = document.getElementById('sendTestAlertBtn');
        if (testBtn) {
            testBtn.addEventListener('click', () => {
                const statusEl = document.getElementById('testAlertStatus');
                statusEl.innerHTML = 'Sending...';
                fetch('/api/send_test_alert', { method: 'POST' })
                    .then(async r=>({ ok: r.ok, data: await r.json() }))
                    .then(({ok, data})=>{
                        if (ok && data.success) {
                            statusEl.innerHTML = '<span class="text-success">Test email sent ‚úÖ</span>';
                        } else {
                            statusEl.innerHTML = `<span class=\"text-danger\">Failed: ${data.error || 'Unknown'}</span>`;
                        }
                    })
                    .catch(()=>{ statusEl.innerHTML = `<span class=\"text-danger\">Error</span>`; });
            });
        }

        // Send test telegram
        const testTgBtn = document.getElementById('sendTestTelegramBtn');
        if (testTgBtn) {
            testTgBtn.addEventListener('click', () => {
                const statusEl = document.getElementById('testTelegramStatus');
                statusEl.innerHTML = 'Sending...';
                fetch('/api/telegram_test_alert', { method: 'POST' })
                    .then(async r=>({ ok: r.ok, data: await r.json() }))
                    .then(({ok, data})=>{
                        if (ok && data.success) {
                            statusEl.innerHTML = '<span class="text-success">Telegram sent üí¨‚úÖ</span>';
                        } else {
                            statusEl.innerHTML = `<span class=\"text-danger\">Failed: ${data?.error || 'Unknown'}</span>`;
                        }
                    })
                    .catch(()=>{ statusEl.innerHTML = `<span class=\"text-danger\">Error</span>`; });
            });
        }
    };
    
    function getSeverityClass(value, type) {
        if (value === null || value === undefined) {
            return 'bg-secondary'; // Grey for N/A
        }

        switch (type) {
            case 'temperature':
                if (value > 30 || value < -10) return 'bg-danger'; // Extreme hot/cold
                if (value > 25 || value < 0) return 'bg-warning';  // Very hot/cold
                return 'bg-success'; // Normal
            case 'humidity':
                if (value > 90 || value < 20) return 'bg-danger'; // Too humid/dry
                if (value > 80 || value < 30) return 'bg-warning'; // Very humid/dry
                return 'bg-success'; // Normal
            case 'pressure': // Assuming hPa
                if (value < 980 || value > 1030) return 'bg-danger'; // Very low/high pressure (stormy/very stable)
                if (value < 1000 || value > 1020) return 'bg-warning'; // Low/high pressure
                return 'bg-success'; // Normal
            case 'wind_speed': // m/s
                if (value > 15) return 'bg-danger'; // Storm/Gale
                if (value > 8) return 'bg-warning';  // Strong wind
                return 'bg-success'; // Moderate/Light wind
            case 'precipitation': // mm
                if (value > 10) return 'bg-danger'; // Heavy rain
                if (value > 2) return 'bg-warning';  // Moderate rain
                return 'bg-success'; // Light/No rain
            case 'precipitation_probability': // %
                if (value > 70) return 'bg-danger'; // High probability
                if (value > 40) return 'bg-warning'; // Moderate probability
                return 'bg-success'; // Low probability
            default:
                return 'bg-primary'; // Default blue for unknown types
        }
    }

    function showTab(tabId) {
        document.getElementById('dashboard-content').style.display = 'none';
        document.getElementById('history-content').style.display = 'none';

        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.classList.remove('active');
        });

        if (tabId === 'dashboard') {
            document.getElementById('dashboard-content').style.display = 'block';
            document.querySelector('a[href="/"]').classList.add('active');
        } else if (tabId === 'history') {
            document.getElementById('history-content').style.display = 'block';
            document.querySelector('a[href="/history"]').classList.add('active');
            loadAllHistoryCharts(); // Load all charts when history tab is shown
        }
    }

    function loadDashboardData() {
        loadCurrentWeather();
        loadSystemStats();
        loadRecentAnalysis();
        loadNextStormPrediction();
        loadWeatherChart();
        loadApiUsageStats();
        loadWeatherAverages();
        loadChmiWarnings();
        loadLightningStats();
        loadSystemStatus();
        loadSnowSummary();
        loadSourceStatus();
        loadRecentEmails();
        updateLastUpdateTime();
        loadClassifierMetrics();
    }
    
    function updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();
    }
    
    function loadCurrentWeather() {
        fetch('/api/current_weather')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('currentWeather');
                if (data.length > 0) {
                    const latest = data[0];
                    container.innerHTML = `
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Teplota
                                <span class="badge rounded-pill ${getSeverityClass(latest.temperature, 'temperature')}">${latest.temperature?.toFixed(1) || 'N/A'}¬∞C</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Vlhkost
                                <span class="badge rounded-pill ${getSeverityClass(latest.humidity, 'humidity')}">${latest.humidity?.toFixed(0) || 'N/A'}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Tlak
                                <span class="badge rounded-pill ${getSeverityClass(latest.pressure, 'pressure')}">${latest.pressure?.toFixed(0) || 'N/A'} hPa</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Rychlost vƒõtru
                                <span class="badge rounded-pill ${getSeverityClass(latest.wind_speed, 'wind_speed')}">${latest.wind_speed?.toFixed(1) || 'N/A'} m/s</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Sr√°≈æky
                                <span class="badge rounded-pill ${getSeverityClass(latest.precipitation, 'precipitation')}">${latest.precipitation?.toFixed(1) || 'N/A'} mm</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Zdroj
                                <span class="badge bg-secondary rounded-pill">${latest.source || 'N/A'}</span>
                            </li>
                        </ul>
                    `;
                } else {
                    container.innerHTML = '<p class="text-center">No weather data available</p>';
                }
            })
            .catch(error => {
                document.getElementById('currentWeather').innerHTML = '<p class="text-center text-danger">Error loading weather data</p>';
                console.error('Error:', error);
            });
    }
    
    function loadSystemStats() {
        fetch('/api/system_stats')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('systemStats');
                container.innerHTML = `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Datov√© body poƒças√≠
                            <span class="badge bg-primary rounded-pill">${data.weather_data_24h || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Anal√Ωz AI
                            <span class="badge bg-primary rounded-pill">${data.ai_analysis_24h || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Odeslan√© e‚Äëmaily
                            <span class="badge bg-primary rounded-pill">${data.emails_24h || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Detekovan√© bou≈ôky (7 dn√≠)
                            <span class="badge bg-primary rounded-pill">${data.storms_detected_7d || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Pr≈Ømƒõrn√° jistota (7 dn√≠)
                            <span class="badge bg-primary rounded-pill">${data.avg_confidence_7d || 0}%</span>
                        </li>
                    </ul>
                `;
            })
            .catch(error => {
                document.getElementById('systemStats').innerHTML = '<p class="text-center text-danger">Error loading statistics</p>';
                console.error('Error:', error);
            });
    }

    function loadLightningStats() {
        fetch('/api/lightning_dashboard_stats')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('lightningStats');
                container.innerHTML = `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            √ödery celkem
                            <span class="badge bg-primary rounded-pill">${data.total_strikes || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            V ƒåR
                            <span class="badge bg-primary rounded-pill">${data.czech_strikes || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            V okol√≠
                            <span class="badge bg-primary rounded-pill">${data.nearby_strikes || 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Posledn√≠ch 24 h</span>
                            <small class="text-muted" id="lightningUpdated"></small>
                        </li>
                    </ul>
                `;
                const t = data.last_updated ? new Date(data.last_updated).toLocaleTimeString('cs-CZ') : new Date().toLocaleTimeString('cs-CZ');
                const el = document.getElementById('lightningUpdated');
                if (el) el.textContent = `aktualizov√°no ${t}`;
            })
            .catch(error => {
                document.getElementById('lightningStats').innerHTML = '<p class="text-center text-danger">Error loading lightning stats</p>';
                console.error('Error:', error);
            });
    }
    
    function loadRecentAnalysis() {
        fetch('/api/recent_analysis')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('recentAnalysis');
                if (data.length > 0) {
                    container.innerHTML = data.slice(0, 5).map(analysis => {
                        const confidence = (analysis.confidence_score * 100).toFixed(1);
                        const confidenceClass = confidence > 80 ? 'text-danger' : 
                                              confidence > 50 ? 'text-warning' : 'text-success';
                        const timestamp = new Date(analysis.timestamp).toLocaleString();
                        
                        let alertLevelClass = 'text-secondary';
                        if (analysis.alert_level === 'Green') alertLevelClass = 'text-success';
                        else if (analysis.alert_level === 'Yellow') alertLevelClass = 'text-warning';
                        else if (analysis.alert_level === 'Orange' || analysis.alert_level === 'Red') alertLevelClass = 'text-danger';

                        return `
                            <div class="list-group-item">
                                <strong>${analysis.storm_detected ? '‚ö° Detekov√°na bou≈ôka' : '‚úÖ Norm√°ln√≠ stav'}</strong>
                                <span class="float-end ${confidenceClass}">${confidence}%</span>
                                <div class="text-muted small">${timestamp} ‚Äì Stav v√Ωstrah: <span class="${alertLevelClass}">${analysis.alert_level}</span></div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-center">≈Ω√°dn√° data anal√Ωz</p>';
                }
            })
            .catch(error => {
                document.getElementById('recentAnalysis').innerHTML = '<p class="text-center text-danger">Chyba p≈ôi naƒç√≠t√°n√≠ dat anal√Ωz</p>';
                console.error('Error:', error);
            });
    }

    function loadNextStormPrediction() {
        fetch('/api/next_storm_prediction')
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(data => {
                const container = document.getElementById('nextStormPrediction');
                if (data && data.prediction_timestamp) {
                    const predictionDate = new Date(data.prediction_timestamp);
                    const confidence = (data.confidence * 100).toFixed(1);
                    container.innerHTML = `
                        <h4 class="text-center">${predictionDate.toLocaleDateString('cs-CZ')} ${predictionDate.toLocaleTimeString('cs-CZ')}</h4>
                        <p class="text-center">Jistota: ${confidence}%</p>
                    `;
                } else {
                    const reason = (data && data.reason) ? data.reason : 'ƒåek√°m na nov√° data/okno modelu.';
                    const nextRun = (data && data.next_run) ? new Date(data.next_run).toLocaleTimeString('cs-CZ') : '‚Äî';
                    container.innerHTML = `<div class="text-center">
                        <p>Predikce zat√≠m nen√≠ dostupn√°.</p>
                        <p class="text-muted small">D≈Øvod: ${reason}</p>
                        <p class="text-muted small">Dal≈°√≠ bƒõh modelu kolem: <strong>${nextRun}</strong></p>
                    </div>`;
                }
            })
            .catch(error => {
                const container = document.getElementById('nextStormPrediction');
                container.innerHTML = '<p class="text-center">Predikce zat√≠m nen√≠ dostupn√°.</p>';
                console.error('Error loading next storm prediction:', error);
            });
    }
    
    function createChmiAnnotations(chmiAlerts) {
        const annotations = {};
        
        chmiAlerts.forEach((alert, index) => {
            if (alert.start_timestamp && alert.end_timestamp) {
                const colorMap = {
                    'green': 'rgba(40, 167, 69, 0.2)',
                    'yellow': 'rgba(255, 193, 7, 0.3)', 
                    'orange': 'rgba(253, 126, 20, 0.4)',
                    'red': 'rgba(220, 53, 69, 0.5)'
                };
                
                annotations[`chmi_${index}`] = {
                    type: 'box',
                    xMin: alert.start_timestamp,
                    xMax: alert.end_timestamp,
                    backgroundColor: colorMap[alert.color] || 'rgba(128, 128, 128, 0.2)',
                    borderColor: colorMap[alert.color] || 'rgba(128, 128, 128, 0.5)',
                    borderWidth: 1,
                    label: {
                        display: true,
                        content: `ƒåHM√ö: ${alert.event}`,
                        position: 'center'
                    }
                };
            }
        });
        
        return annotations;
    }
    
    function reportStormEvent(type) {
        fetch('/api/storm_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ type: type })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Ud√°lost "${type}" byla √∫spƒõ≈°nƒõ zaznamen√°na v ${data.timestamp}`);
                // Reload chart to potentially show updated data
                loadWeatherChart();
            } else {
                alert('Chyba p≈ôi zaznamen√°v√°n√≠ ud√°losti: ' + (data.error || 'Nezn√°m√° chyba'));
            }
        })
        .catch(error => {
            console.error('Error reporting storm event:', error);
            alert('Chyba p≈ôi komunikaci se serverem');
        });
    }
    
    function loadWeatherChart() {
        fetch('/api/weather_history?hours=24')
            .then(response => response.json())
            .then(response => {
                // Handle new API structure with weather_data and chmi_alerts
                const data = response.weather_data || response;
                const chmiAlerts = response.chmi_alerts || [];
                
                if (!data || data.length === 0) {
                    document.getElementById('weatherChart').getContext('2d').clearRect(0, 0, document.getElementById('weatherChart').width, document.getElementById('weatherChart').height);
                    if (weatherChart) weatherChart.destroy();
                    return;
                }
                
                const ctx = document.getElementById('weatherChart').getContext('2d');
                
                const openweatherData = data.filter(d => d.source === 'openweather');
                const visualcrossingData = data.filter(d => d.source === 'visual_crossing');
                const tomorrowioData = data.filter(d => d.source === 'tomorrow_io');
                
                if (weatherChart) {
                    weatherChart.destroy();
                }
                
                weatherChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Temperature (¬∞C) - OpenWeather',
                                data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y-temp'
                            },
                            {
                                label: 'Temperature (¬∞C) - Visual Crossing',
                                data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y-temp'
                            },
                            {
                                label: 'Temperature (¬∞C) - Tomorrow.io',
                                data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                borderColor: 'rgba(255, 206, 86, 1)',
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y-temp'
                            },
                            {
                                label: 'Wind Speed (m/s) - OpenWeather',
                                data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.wind_speed })),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y-wind'
                            },
                            {
                                label: 'Humidity (%) - OpenWeather',
                                data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.humidity })),
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y-humidity'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            'y-temp': {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C)'
                                },
                                grid: {
                                    drawOnChartArea: true,
                                },
                            },
                            'y-wind': {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Wind Speed (m/s)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                // Offset this axis slightly if it overlaps with y-humidity
                                // offset: true 
                            },
                            'y-humidity': {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Humidity (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                // Ensure this axis is distinct from y-wind if both are on the right
                                // You might need to adjust `offset` or `position` more carefully
                                // For now, let's assume they won't overlap too badly or one will be primary
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x',
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                }
                            },
                            annotation: {
                                annotations: createChmiAnnotations(chmiAlerts)
                            }
                        }
                    }
                });

                // Register for global theme updates
                try {
                    window.appCharts = window.appCharts || [];
                    if (!window.appCharts.includes(weatherChart)) {
                        window.appCharts.push(weatherChart);
                    }
                } catch (_) {}

                // Fetch 24h future forecast temperatures and add as a dashed line
                fetch('/api/enhanced_forecast_24h')
                    .then(r => r.json())
                    .then(future => {
                        if (!future || !future.points || future.points.length === 0) return;
                        // Smooth future temps to avoid jagged lines and limit step per hour
                        const raw = future.points.map(p => ({ x: new Date(p.timestamp), y: p.temperature }));
                        raw.sort((a,b)=>a.x-b.x);
                        const futureData = [];
                        for (let i=0;i<raw.length;i++) {
                            const prev = i>0 ? futureData[i-1].y : null;
                            let y = raw[i].y;
                            if (prev !== null) {
                                const maxStep = 2.5;
                                if (y > prev + maxStep) y = prev + maxStep;
                                if (y < prev - maxStep) y = prev - maxStep;
                            }
                            futureData.push({ x: raw[i].x, y });
                        }
                        // Extend the visible x-range to include up to +24h if needed
                        try {
                            const currentMax = new Date(data[data.length - 1].timestamp);
                            const futureMax = new Date(future.points[future.points.length - 1].timestamp);
                            const xScale = weatherChart.options.scales.x;
                            const newMax = futureMax > currentMax ? futureMax : currentMax;
                            if (!xScale.min || !xScale.max || newMax > new Date(xScale.max)) {
                                xScale.min = new Date(data[0].timestamp);
                                xScale.max = newMax;
                            }
                        } catch (_) {}

                        weatherChart.data.datasets.push({
                            label: `Future Temperature (next 24h) - ${future.method === 'ai' ? 'AI' : 'Ensemble'}`,
                            data: futureData,
                            borderColor: future.method === 'ai' ? 'rgba(255, 0, 0, 0.9)' : 'rgba(0, 128, 0, 0.9)',
                            backgroundColor: future.method === 'ai' ? 'rgba(255, 0, 0, 0.05)' : 'rgba(0, 128, 0, 0.05)',
                            borderDash: [8, 6],
                            pointRadius: 0,
                            tension: 0.25,
                            fill: false,
                            yAxisID: 'y-temp'
                        });
                        weatherChart.update('none');
                    })
                    .catch(() => {});
            })
            .catch(error => {
                console.error('Error loading weather chart:', error);
                document.getElementById('weatherChart').getContext('2d').clearRect(0, 0, document.getElementById('weatherChart').width, document.getElementById('weatherChart').height);
                if (weatherChart) weatherChart.destroy();
            });
    }
    
    function loadApiUsageStats() {
        fetch('/api/api_usage_stats')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('apiUsageStats');
                let html = '<ul class="list-group list-group-flush">';
                
                html += '<li class="list-group-item list-group-item-info d-flex justify-content-between align-items-center"><strong>Vol√°n√≠ API (24 h)</strong><small class="text-muted" id="apiUsageUpdated"></small></li>';
                if (data.usage_24h && Object.keys(data.usage_24h).length > 0) {
                    Object.entries(data.usage_24h).forEach(([source, count]) => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${source}
                            <span class="badge bg-primary rounded-pill">${count}</span>
                        </li>`;
                    });
                } else {
                    html += '<li class="list-group-item">≈Ω√°dn√° data za posledn√≠ch 24h</li>';
                }
                
                html += '</ul>';
                container.innerHTML = html;
                const el = document.getElementById('apiUsageUpdated');
                if (el) el.textContent = `aktualizov√°no ${new Date().toLocaleTimeString('cs-CZ')}`;
            })
            .catch(error => {
                document.getElementById('apiUsageStats').innerHTML = '<p class="text-center text-danger">Error loading API usage data</p>';
                console.error('Error:', error);
            });
    }
    
    function loadWeatherAverages() {
        fetch('/api/weather_averages')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('weatherAverages');
                
                if (data.source_count > 0) {
                    container.innerHTML = `
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Pr≈Ømƒõr teplota
                                <span class="badge rounded-pill ${getSeverityClass(data.temperature, 'temperature')}">${data.temperature?.toFixed(1) || 'N/A'}¬∞C</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Pr≈Ømƒõr vlhkost
                                <span class="badge rounded-pill ${getSeverityClass(data.humidity, 'humidity')}">${data.humidity?.toFixed(0) || 'N/A'}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Pr≈Ømƒõr tlak
                                <span class="badge rounded-pill ${getSeverityClass(data.pressure, 'pressure')}">${data.pressure?.toFixed(0) || 'N/A'} hPa</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Pr≈Ømƒõr v√≠tr
                                <span class="badge rounded-pill ${getSeverityClass(data.wind_speed, 'wind_speed')}">${data.wind_speed?.toFixed(1) || 'N/A'} m/s</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Sr√°≈æky pravdƒõp.
                                <span class="badge rounded-pill ${getSeverityClass(data.precipitation_probability, 'precipitation_probability')}">${data.precipitation_probability?.toFixed(0) || 'N/A'}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                API zdroj≈Ø
                                <span class="badge bg-secondary rounded-pill">${data.source_count}</span>
                            </li>
                        </ul>
                    `;
                } else {
                    container.innerHTML = '<p class="text-center">≈Ω√°dn√° aktu√°ln√≠ data k dispozici</p>';
                }
            })
            .catch(error => {
                document.getElementById('weatherAverages').innerHTML = '<p class="text-center text-danger">Error loading average data</p>';
                console.error('Error:', error);
            });
    }
    
    function loadChmiWarnings() {
        fetch('/api/chmi_warnings')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('chmiWarnings');
                
                if (data.warnings && data.warnings.length > 0) {
                    let html = `<div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="alert alert-info mb-0">
                                <h6 class="mb-1"><strong>üìä Souhrn varov√°n√≠</strong></h6>
                                Celkem aktivn√≠ch varov√°n√≠: <strong>${data.total_warnings}</strong>
                                ${data.storm_warnings > 0 ? `&nbsp;‚Ä¢&nbsp;<span class="text-danger">Bou≈ôkov√° varov√°n√≠: <strong>${data.storm_warnings}</strong></span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="row">`;
                    
                    data.warnings.forEach((warning, index) => {
                        // Map ƒåHM√ö colors to Bootstrap alert classes and icons
                        let alertClass = 'alert-info';
                        let severityIcon = '‚ÑπÔ∏è';
                        switch (warning.color) {
                            case 'green': 
                                alertClass = 'alert-success'; 
                                severityIcon = 'üü¢';
                                break;
                            case 'yellow': 
                                alertClass = 'alert-warning'; 
                                severityIcon = 'üü°';
                                break;
                            case 'orange': 
                                alertClass = 'alert-danger'; 
                                severityIcon = 'üü†';
                                break;
                            case 'red': 
                                alertClass = 'alert-danger'; 
                                severityIcon = 'üî¥';
                                break;
                        }

                        const startTime = warning.time_start ? new Date(warning.time_start).toLocaleString('cs-CZ', {
                            day: '2-digit', 
                            month: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit'
                        }) : 'Neuvedeno';
                        const endTime = warning.time_end ? new Date(warning.time_end).toLocaleString('cs-CZ', {
                            day: '2-digit', 
                            month: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit'
                        }) : 'Neuvedeno';
                        
                        // Use responsive column sizing
                        const colClass = data.warnings.length === 1 ? 'col-12' : 
                                        data.warnings.length === 2 ? 'col-md-6' : 'col-lg-4 col-md-6';
                        
                        html += `<div class="${colClass} mb-3">
                            <div class="alert ${alertClass} h-100 mb-0">
                                <h6 class="alert-heading">
                                    ${severityIcon} ${warning.event}
                                    <span class="badge bg-secondary float-end">${warning.color.toUpperCase()}</span>
                                </h6>
                                <p class="mb-2">${warning.description || 'Bez detailn√≠ho popisu'}</p>
                                <hr class="my-2">
                                <small>
                                    <strong>Od:</strong> ${startTime}<br>
                                    <strong>Do:</strong> ${endTime}
                                </small>
                            </div>
                        </div>`;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="alert alert-success mb-0">
                        <h6 class="mb-2"><strong>‚úÖ Bez aktivn√≠ch varov√°n√≠</strong></h6>
                        <p class="mb-0">≈Ω√°dn√° meteorologick√° varov√°n√≠ nejsou moment√°lnƒõ vyd√°na pro oblast Brno.</p>
                    </div>`;
                }
            })
            .catch(error => {
                document.getElementById('chmiWarnings').innerHTML = '<div class="alert alert-danger mb-0"><strong>‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ varov√°n√≠</strong><br>Nepoda≈ôilo se naƒç√≠st data z ƒåHM√ö.</div>';
                console.error('Error:', error);
            });
    }

    function loadSystemStatus() {
        fetch('/api/system_status')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('systemStatus');
                if (data.error) {
                    container.innerHTML = `<p class="text-center text-danger">${data.error}</p>`;
                    return;
                }
                const tempClass = data.cpu_temp > 75 ? 'text-danger' : data.cpu_temp > 60 ? 'text-warning' : 'text-success';
                const cpuClass = data.cpu_percent > 80 ? 'text-danger' : data.cpu_percent > 50 ? 'text-warning' : 'text-success';
                const ramClass = data.ram_percent > 85 ? 'text-danger' : data.ram_percent > 70 ? 'text-warning' : 'text-success';
                container.innerHTML = `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Teplota CPU
                            <span class="badge rounded-pill ${tempClass}">${data.cpu_temp?.toFixed(1) || 'N/A'}¬∞C</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Vyu≈æit√≠ CPU
                            <span class="badge rounded-pill ${cpuClass}">${data.cpu_percent?.toFixed(1) || 'N/A'}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Vyu≈æit√≠ RAM
                            <span class="badge rounded-pill ${ramClass}">${data.ram_percent?.toFixed(1) || 'N/A'}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Velikost datab√°ze
                            <span class="badge bg-info rounded-pill">${data.database_size_mb?.toFixed(2) || 'N/A'} MB</span>
                        </li>
                    </ul>
                `;
            })
            .catch(error => {
                document.getElementById('systemStatus').innerHTML = '<p class="text-center text-danger">Error loading system status.</p>';
                console.error('Error:', error);
            });
    }

    function loadSnowSummary() {
        fetch('/api/snow_summary')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('snowSummary');
                if (data.error) {
                    container.innerHTML = `<p class="text-center text-danger">${data.error}</p>`;
                    return;
                }
                const cur = data.current;
                const forecast = data.forecast || {};
                const warnings = data.warnings || [];
                const risk = data.risk_level || 'LOW';
                const riskBadge = risk === 'HIGH' ? 'bg-danger' : (risk === 'MEDIUM' ? 'bg-warning' : 'bg-success');
                let html = `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Risk Level
                            <span class="badge ${riskBadge} rounded-pill">${risk}</span>
                        </li>
                        <li class="list-group-item">
                            <div><strong>Current:</strong> ${cur ? `${cur.temperature?.toFixed?.(1) ?? cur.temperature}¬∞C, ${cur.description || ''}` : 'N/A'}</div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Subzero (next 12h)
                            <span class="badge bg-secondary rounded-pill">${forecast.subzero_hours ?? 0}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Snow-risk hours (next 12h)
                            <span class="badge bg-secondary rounded-pill">${forecast.snow_risk_hours ?? 0}</span>
                        </li>
                        ${forecast.first_freeze_time ? `<li class="list-group-item">First freeze: <strong>${forecast.first_freeze_time}</strong></li>` : ''}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Min temp (24h)
                            <span class="badge bg-secondary rounded-pill">${data.min_temp_24h ?? 'N/A'}¬∞C</span>
                        </li>
                        <li class="list-group-item">
                            <strong>CHMI Warnings:</strong>
                            ${warnings.length ? warnings.map(w=>`<div><span class="badge bg-${w.color==='red'?'danger':w.color==='orange'?'warning':w.color==='yellow'?'warning':'secondary'}">${w.color?.toUpperCase()}</span> ${w.event}</div>`).join('') : 'None'}
                        </li>
                    </ul>
                `;
                container.innerHTML = html;
            })
            .catch(error => {
                document.getElementById('snowSummary').innerHTML = '<p class="text-center text-danger">Error loading snow summary</p>';
                console.error('Error:', error);
            });
    }

    function loadRecentEmails() {
        fetch('/api/notification_history')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('recentEmails');
                if (data.error) {
                    container.innerHTML = `<p class="text-center text-danger">${data.error}</p>`;
                    return;
                }
                if (Array.isArray(data) && data.length > 0) {
                    let html = '<ul class="list-group list-group-flush">';
                    data.slice(0, 5).forEach(item => {
                        const isSuccess = item.ok;
                        const channelIcon = item.channel === 'telegram' ? 'üí¨' : 'üìß';
                        const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
                        const title = (item.title || 'Alert').toString();
                        const short = title.length > 48 ? title.substring(0, 45) + '‚Ä¶' : title;
                        const timestamp = new Date(item.timestamp).toLocaleString('cs-CZ');
                        html += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span>${channelIcon} ${statusIcon} ${short}</span>
                                    <small class="text-muted">${timestamp}</small>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-center">No recent emails.</p>';
                }
            })
            .catch(error => {
                document.getElementById('recentEmails').innerHTML = '<p class="text-center text-danger">Error loading email history.</p>';
                console.error('Error:', error);
            });
    }

    // Render ROC/PR using Chart.js
    let rocChartInstance = null;
    let prChartInstance = null;
    function buildRocChart(points, auc) {
        const ctx = document.getElementById('rocChart');
        if (!ctx) return;
        if (rocChartInstance) { try { rocChartInstance.destroy(); } catch(_) {} }
        const data = points.sort((a,b)=>a.fpr-b.fpr).map(p=>({x:+p.fpr.toFixed(3), y:+p.tpr.toFixed(3)}));
        rocChartInstance = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{ label: `ROC (AUC ${auc ?? ''})`, data, borderColor: '#0ea5b1', backgroundColor: 'rgba(14,165,177,0.15)', fill: false, tension: 0.1, pointRadius: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                parsing: false,
                scales: {
                    x: { type: 'linear', min: 0, max: 1, title: { display: true, text: 'FPR' }, ticks: { maxTicksLimit: 6 } },
                    y: { type: 'linear', min: 0, max: 1, title: { display: true, text: 'TPR' }, ticks: { maxTicksLimit: 6 } },
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                elements: { line: { borderWidth: 2 } },
                animation: false,
                interaction: { mode: 'nearest', intersect: false }
            }
        });
    }
    function buildPrChart(points, ap) {
        const ctx = document.getElementById('prChart');
        if (!ctx) return;
        if (prChartInstance) { try { prChartInstance.destroy(); } catch(_) {} }
        const data = points.sort((a,b)=>a.recall-b.recall).map(p=>({x:+p.recall.toFixed(3), y:+p.precision.toFixed(3)}));
        prChartInstance = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{ label: `PR (AP ${ap ?? ''})`, data, borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.15)', fill: false, tension: 0.1, pointRadius: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                parsing: false,
                scales: {
                    x: { type: 'linear', min: 0, max: 1, title: { display: true, text: 'Recall' }, ticks: { maxTicksLimit: 6 } },
                    y: { type: 'linear', min: 0, max: 1, title: { display: true, text: 'Precision' }, ticks: { maxTicksLimit: 6 } },
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                elements: { line: { borderWidth: 2 } },
                animation: false,
                interaction: { mode: 'nearest', intersect: false }
            }
        });
    }
    function loadClassifierMetrics() {
        fetch('/api/classifier_metrics?days=30', { cache: 'no-store' }).then(r=>r.json()).then(m=>{
            if (m.error) return;
            const rocMeta = document.getElementById('rocMeta');
            const prMeta = document.getElementById('prMeta');
            if (rocMeta) rocMeta.textContent = `AUC ${m.auc ?? '‚Äì'} ‚Ä¢ vzork≈Ø ${m.counts?.total ?? '‚Äì'}`;
            if (prMeta) prMeta.textContent = `AP ${m.avg_precision ?? '‚Äì'} ‚Ä¢ Brier ${m.brier ?? '‚Äì'}`;
            buildRocChart(m.roc || [], m.auc);
            buildPrChart(m.pr || [], m.avg_precision);
        }).catch(()=>{});
    }

    function loadSourceStatus() {
        fetch('/api/source_status')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('sourceStatus');
                if (!data || !data.sources) {
                    container.innerHTML = '<p class="text-center">≈Ω√°dn√° data o zdroj√≠ch</p>';
                    return;
                }
                const statusBadge = (ok) => ok ? 'bg-success' : 'bg-danger';
                const rows = [
                    { key: 'openweather', label: 'OpenWeather' },
                    { key: 'tomorrow_io', label: 'Tomorrow.io' },
                    { key: 'visual_crossing', label: 'Visual Crossing' },
                    { key: 'chmi', label: 'ƒåHM√ö scraping' }
                ].map(src => {
                    const s = data.sources[src.key] || {};
                    const t = s.last_ok ? new Date(s.last_ok).toLocaleString('cs-CZ') : '‚Äî';
                    const err = s.last_error ? `<div class="text-danger small">${s.last_error}</div>` : '';
                    return `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${src.label}</span>
                        <span>
                            <span class="badge ${statusBadge(s.ok)} me-2">${s.ok ? 'OK' : 'Chyba'}</span>
                            <small class="text-muted">${t}</small>
                        </span>
                        ${err}
                    </li>`;
                }).join('');
                container.innerHTML = `<ul class="list-group list-group-flush">${rows}</ul>`;
            })
            .catch(() => {
                const container = document.getElementById('sourceStatus');
                container.innerHTML = '<p class="text-center text-danger">Chyba p≈ôi naƒç√≠t√°n√≠ stavu zdroj≈Ø</p>';
            });
    }

    const metricConfigs = {
        temperature: { label: 'Temperature (¬∞C)', unit: '¬∞C', color: 'rgba(255, 99, 132, 1)' },
        humidity: { label: 'Humidity (%)', unit: '%', color: 'rgba(54, 162, 235, 1)' },
        pressure: { label: 'Pressure (hPa)', unit: 'hPa', color: 'rgba(75, 192, 192, 1)' },
        wind_speed: { label: 'Wind Speed (m/s)', unit: 'm/s', color: 'rgba(153, 102, 255, 1)' },
        precipitation: { label: 'Precipitation (mm)', unit: 'mm', color: 'rgba(255, 159, 64, 1)' },
        precipitation_probability: { label: 'Precipitation Probability (%)', unit: '%', color: 'rgba(201, 203, 207, 1)' }
    };

    function loadAllHistoryCharts() {
        const timeline = document.getElementById('historyTimeline').value;

        fetch(`/api/weather_history?hours=${timeline}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    // Clear all history charts if no data
                    Object.keys(metricConfigs).forEach(metric => {
                        const ctx = document.getElementById(`historyChart${metric.charAt(0).toUpperCase() + metric.slice(1)}`).getContext('2d');
                        if (historyCharts[metric]) {
                            historyCharts[metric].destroy();
                            delete historyCharts[metric];
                        }
                        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    });
                    return;
                }

                Object.keys(metricConfigs).forEach(metric => {
                    const config = metricConfigs[metric];
                    const canvasId = `historyChart${metric.charAt(0).toUpperCase() + metric.slice(1)}`;
                    const ctx = document.getElementById(canvasId).getContext('2d');

                    if (historyCharts[metric]) {
                        historyCharts[metric].destroy();
                    }

                    const datasets = [
                        {
                            label: `${config.label} - OpenWeather`,
                            data: data.filter(d => d.source === 'openweather').map(d => ({ x: new Date(d.timestamp), y: d[metric] })),
                            borderColor: config.color,
                            backgroundColor: config.color.replace('1)', '0.2)'),
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: `${config.label} - Visual Crossing`,
                            data: data.filter(d => d.source === 'visual_crossing').map(d => ({ x: new Date(d.timestamp), y: d[metric] })),
                            borderColor: config.color,
                            backgroundColor: config.color.replace('1)', '0.2)'),
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: `${config.label} - Tomorrow.io`,
                            data: data.filter(d => d.source === 'tomorrow_io').map(d => ({ x: new Date(d.timestamp), y: d[metric] })),
                            borderColor: config.color,
                            backgroundColor: config.color.replace('1)', '0.2)'),
                            tension: 0.3,
                            fill: false,
                        }
                    ];

                    historyCharts[metric] = new Chart(ctx, {
                        type: 'line',
                        data: { datasets: datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'hour',
                                        displayFormats: {
                                            hour: 'HH:mm'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: `${config.label}`
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Register for global theme updates
                    try {
                        window.appCharts = window.appCharts || [];
                        if (!window.appCharts.includes(historyCharts[metric])) {
                            window.appCharts.push(historyCharts[metric]);
                        }
                    } catch (_) {}
                });

                loadCombinedHistoryChart(data);
                loadHistoryChartWindPrecipitation(data);
                loadHistoryChartPrecipitationProbabilityCombined(data);
            })
            .catch(error => {
                console.error('Error loading history charts:', error);
            });
    }

    function loadCombinedHistoryChart(data) {
        const ctx = document.getElementById('historyChartCombined').getContext('2d');

        if (historyCharts.combined) {
            historyCharts.combined.destroy();
        }

        const openweatherData = data.filter(d => d.source === 'openweather');
        const visualcrossingData = data.filter(d => d.source === 'visual_crossing');
        const tomorrowioData = data.filter(d => d.source === 'tomorrow_io');

        historyCharts.combined = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Temperature (¬∞C) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-temp'
                    },
                    {
                        label: 'Humidity (%) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.humidity })),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-humidity'
                    },
                    {
                        label: 'Pressure (hPa) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.pressure })),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-pressure'
                    },
                    {
                        label: 'Temperature (¬∞C) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                        borderColor: 'rgba(255, 99, 132, 0.7)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-temp'
                    },
                    {
                        label: 'Humidity (%) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.humidity })),
                        borderColor: 'rgba(54, 162, 235, 0.7)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-humidity'
                    },
                    {
                        label: 'Pressure (hPa) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.pressure })),
                        borderColor: 'rgba(75, 192, 192, 0.7)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-pressure'
                    },
                    {
                        label: 'Temperature (¬∞C) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                        borderColor: 'rgba(255, 99, 132, 0.4)',
                        backgroundColor: 'rgba(255, 99, 132, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-temp'
                    },
                    {
                        label: 'Humidity (%) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.humidity })),
                        borderColor: 'rgba(54, 162, 235, 0.4)',
                        backgroundColor: 'rgba(54, 162, 235, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-humidity'
                    },
                    {
                        label: 'Pressure (hPa) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.pressure })),
                        borderColor: 'rgba(75, 192, 192, 0.4)',
                        backgroundColor: 'rgba(75, 192, 192, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-pressure'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    'y-temp': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        grid: {
                            drawOnChartArea: true,
                        },
                    },
                    'y-humidity': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Humidity (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    'y-pressure': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Pressure (hPa)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        // Offset this axis slightly if it overlaps with y-humidity
                        offset: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function loadHistoryChartWindPrecipitation(data) {
        const ctx = document.getElementById('historyChartWindPrecipitation').getContext('2d');

        if (historyCharts.windPrecipitation) {
            historyCharts.windPrecipitation.destroy();
        }

        const openweatherData = data.filter(d => d.source === 'openweather');
        const visualcrossingData = data.filter(d => d.source === 'visual_crossing');
        const tomorrowioData = data.filter(d => d.source === 'tomorrow_io');

        historyCharts.windPrecipitation = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Wind Speed (m/s) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.wind_speed })),
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-wind'
                    },
                    {
                        label: 'Precipitation (mm) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    },
                    {
                        label: 'Wind Speed (m/s) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.wind_speed })),
                        borderColor: 'rgba(255, 159, 64, 0.7)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-wind'
                    },
                    {
                        label: 'Precipitation (mm) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(54, 162, 235, 0.7)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    },
                    {
                        label: 'Wind Speed (m/s) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.wind_speed })),
                        borderColor: 'rgba(255, 159, 64, 0.4)',
                        backgroundColor: 'rgba(255, 159, 64, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-wind'
                    },
                    {
                        label: 'Precipitation (mm) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(54, 162, 235, 0.4)',
                        backgroundColor: 'rgba(54, 162, 235, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    'y-wind': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Wind Speed (m/s)'
                        },
                        grid: {
                            drawOnChartArea: true,
                        },
                    },
                    'y-precipitation': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Precipitation (mm)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        offset: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function loadHistoryChartPrecipitationProbabilityCombined(data) {
        const ctx = document.getElementById('historyChartPrecipitationProbabilityCombined').getContext('2d');

        if (historyCharts.precipitationProbabilityCombined) {
            historyCharts.precipitationProbabilityCombined.destroy();
        }

        const openweatherData = data.filter(d => d.source === 'openweather');
        const visualcrossingData = data.filter(d => d.source === 'visual_crossing');
        const tomorrowioData = data.filter(d => d.source === 'tomorrow_io');

        historyCharts.precipitationProbabilityCombined = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Precipitation (mm) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    },
                    {
                        label: 'Precipitation Probability (%) - OpenWeather',
                        data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation_probability })),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation-probability'
                    },
                    {
                        label: 'Precipitation (mm) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(255, 99, 132, 0.7)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    },
                    {
                        label: 'Precipitation Probability (%) - Visual Crossing',
                        data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation_probability })),
                        borderColor: 'rgba(54, 162, 235, 0.7)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation-probability'
                    },
                    {
                        label: 'Precipitation (mm) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation })),
                        borderColor: 'rgba(255, 99, 132, 0.4)',
                        backgroundColor: 'rgba(255, 99, 132, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation'
                    },
                    {
                        label: 'Precipitation Probability (%) - Tomorrow.io',
                        data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.precipitation_probability })),
                        borderColor: 'rgba(54, 162, 235, 0.4)',
                        backgroundColor: 'rgba(54, 162, 235, 0.05)',
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y-precipitation-probability'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    'y-precipitation': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Precipitation (mm)'
                        },
                        grid: {
                            drawOnChartArea: true,
                        },
                    },
                    'y-precipitation-probability': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Precipitation Probability (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        offset: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    document.getElementById('enableNotifications').addEventListener('click', () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                        fetch('/api/vapid_public_key')
                            .then(response => response.json())
                            .then(data => {
                                const vapidPublicKey = data.public_key;
                                const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

                                registration.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: convertedVapidKey
                                }).then(subscription => {
                                    fetch('/api/subscribe', {
                                        method: 'POST',
                                        body: JSON.stringify(subscription),
                                        headers: {
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                });
                            });
                    }
                });
            });
        }
    });
</script>

<!-- Enhanced Forecast JavaScript -->
<script src="{{ url_for('static', filename='enhanced_forecast.js') }}"></script>

{% endblock %}
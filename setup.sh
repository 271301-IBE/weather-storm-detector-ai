#!/bin/bash

# Weather Storm Detection System - Complete Setup Script
# Tento script nainstaluje a nakonfiguruje cel√Ω syst√©m pro detekci bou≈ô√≠

set -e  # Exit on any error

echo "üå©Ô∏è Weather Storm Detection System - Setup Script"
echo "=================================================="
echo "Tento script nainstaluje a nakonfiguruje kompletn√≠ syst√©m."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
   print_error "Nespou≈°tƒõjte tento script jako root!"
   exit 1
fi

# Detect OS
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
    print_info "Detekov√°n Linux syst√©m"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
    print_info "Detekov√°n macOS syst√©m"
else
    print_error "Nepodporovan√Ω operaƒçn√≠ syst√©m: $OSTYPE"
    exit 1
fi

# Step 1: System dependencies
echo ""
echo "üì¶ Krok 1: Instalace syst√©mov√Ωch z√°vislost√≠"
echo "============================================"

if [[ "$OS" == "linux" ]]; then
    # Update package list
    print_info "Aktualizace seznamu bal√≠ƒçk≈Ø..."
    sudo apt update

    # Install system dependencies
    print_info "Instalace syst√©mov√Ωch bal√≠ƒçk≈Ø..."
    sudo apt install -y python3 python3-pip python3-venv git curl wget \
                        build-essential libssl-dev libffi-dev python3-dev \
                        sqlite3 cron systemd bc \
                        libjpeg-dev zlib1g-dev libpng-dev libtiff-dev \
                        libfreetype6-dev liblcms2-dev libwebp-dev

    print_status "Syst√©mov√© bal√≠ƒçky nainstalov√°ny"

elif [[ "$OS" == "macos" ]]; then
    # Check if Homebrew is installed
    if ! command -v brew &> /dev/null; then
        print_info "Instalace Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Install dependencies via Homebrew
    print_info "Instalace z√°vislost√≠ p≈ôes Homebrew..."
    brew install python3 git sqlite3

    print_status "Syst√©mov√© bal√≠ƒçky nainstalov√°ny"
fi

# Step 2: Python environment setup
echo ""
echo "üêç Krok 2: Nastaven√≠ Python prost≈ôed√≠"
echo "======================================"

# Check Python version
PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
print_info "Detekov√°na Python verze: $PYTHON_VERSION"

# Skip version check - commented out
# if [[ $(echo "$PYTHON_VERSION < 3.8" | bc -l) -eq 1 ]]; then
#     print_error "Vy≈æadov√°na Python verze 3.8 nebo vy≈°≈°√≠!"
#     exit 1
# fi

# Create virtual environment
print_info "Vytv√°≈ôen√≠ virtu√°ln√≠ho prost≈ôed√≠..."
python3 -m venv weather_env

# Activate virtual environment
print_info "Aktivace virtu√°ln√≠ho prost≈ôed√≠..."
source weather_env/bin/activate

# Upgrade pip
print_info "Aktualizace pip..."
pip install --upgrade pip

# Install Python dependencies
print_info "Instalace Python z√°vislost√≠..."
cat > requirements.txt << EOF
aiohttp==3.9.1
asyncio-throttle==1.0.2
APScheduler==3.10.4
requests==2.31.0
python-dotenv==1.0.0
psutil==5.9.6
reportlab==4.0.7
lxml==4.9.3
python-dateutil==2.8.2
pytz==2023.3
aiosqlite==0.19.0
EOF

pip install -r requirements.txt

print_status "Python prost≈ôed√≠ nastaveno"

# Step 3: Configuration
echo ""
echo "‚öôÔ∏è  Krok 3: Konfigurace syst√©mu"
echo "==============================="

# Create .env file with user input
print_info "Nastaven√≠ konfigurace..."

echo "Zadejte pros√≠m n√°sleduj√≠c√≠ √∫daje:"
echo ""

# Weather API keys
echo "üå§Ô∏è  API kl√≠ƒçe pro poƒças√≠:"
read -p "OpenWeather API kl√≠ƒç: " OPENWEATHER_KEY
read -p "Visual Crossing API kl√≠ƒç: " VISUAL_CROSSING_KEY

echo ""
echo "ü§ñ DeepSeek AI API:"
read -p "DeepSeek API kl√≠ƒç: " DEEPSEEK_KEY

echo ""
echo "üìß Email konfigurace:"
read -p "Odes√≠lac√≠ email (Seznam.cz): " SENDER_EMAIL
read -s -p "Heslo k emailu: " SENDER_PASSWORD
echo ""
read -p "P≈ô√≠jemce email≈Ø: " RECIPIENT_EMAIL

echo ""
echo "üìç Lokace:"
read -p "N√°zev mƒõsta [Brno]: " CITY_NAME
CITY_NAME=${CITY_NAME:-Brno}
read -p "Region [South Moravia]: " REGION
REGION=${REGION:-"South Moravia"}
read -p "Zemƒõpisn√° ≈°√≠≈ôka [49.2384]: " LATITUDE
LATITUDE=${LATITUDE:-49.2384}
read -p "Zemƒõpisn√° d√©lka [16.6073]: " LONGITUDE
LONGITUDE=${LONGITUDE:-16.6073}

# Create .env file
cat > .env << EOF
# Weather API Configuration
OPENWEATHER_API_KEY=$OPENWEATHER_KEY
VISUAL_CROSSING_API_KEY=$VISUAL_CROSSING_KEY

# Location Configuration
CITY_NAME=$CITY_NAME
REGION=$REGION
LATITUDE=$LATITUDE
LONGITUDE=$LONGITUDE

# AI Configuration
DEEPSEEK_API_KEY=$DEEPSEEK_KEY
DEEPSEEK_API_URL=https://api.deepseek.com/v1
STORM_CONFIDENCE_THRESHOLD=0.99

# Email Configuration
SMTP_SERVER=smtp.seznam.cz
SMTP_PORT=465
SMTP_USE_SSL=true
SENDER_EMAIL=$SENDER_EMAIL
SENDER_PASSWORD=$SENDER_PASSWORD
SENDER_NAME=Clipron AI Weather Detection
RECIPIENT_EMAIL=$RECIPIENT_EMAIL
EMAIL_DELAY_MINUTES=30

# System Configuration
MONITORING_INTERVAL_MINUTES=10
DAILY_SUMMARY_HOUR=9
DATABASE_PATH=./weather_data.db
EOF

print_status "Konfigurace vytvo≈ôena"

# Step 4: Directory structure
echo ""
echo "üìÅ Krok 4: Vytv√°≈ôen√≠ adres√°≈ôov√© struktury"
echo "========================================"

# Create necessary directories
mkdir -p logs reports temp

print_status "Adres√°≈ôov√° struktura vytvo≈ôena"

# Step 5: Database initialization
echo ""
echo "üóÑÔ∏è  Krok 5: Inicializace datab√°ze"
echo "================================="

print_info "Vytv√°≈ôen√≠ datab√°ze..."
python3 -c "
from storage import WeatherDatabase
from config import load_config
config = load_config()
db = WeatherDatabase(config)
print('Datab√°ze inicializov√°na √∫spƒõ≈°nƒõ')
"

print_status "Datab√°ze p≈ôipravena"

# Step 6: System testing
echo ""
echo "üß™ Krok 6: Testov√°n√≠ syst√©mu"
echo "==========================="

print_info "Spou≈°t√≠m testy syst√©mu..."
if python3 test_system.py > test_output.log 2>&1; then
    print_status "V≈°echny testy pro≈°ly √∫spƒõ≈°nƒõ!"
else
    print_warning "Nƒõkter√© testy selhaly. Zkontrolujte test_output.log"
fi

# Step 7: Service setup (Linux only)
if [[ "$OS" == "linux" ]]; then
    echo ""
    echo "üîß Krok 7: Nastaven√≠ systemd slu≈æby"
    echo "==================================="

    read -p "Chcete nastavit automatick√© spou≈°tƒõn√≠ p≈ôi startu? (y/N): " AUTO_START
    if [[ $AUTO_START =~ ^[Yy]$ ]]; then
        CURRENT_DIR=$(pwd)
        CURRENT_USER=$(whoami)

        # Create systemd service file
        sudo tee /etc/systemd/system/weather-monitor.service > /dev/null << EOF
[Unit]
Description=Weather Storm Detection System
After=network.target
Wants=network.target

[Service]
Type=simple
User=$CURRENT_USER
WorkingDirectory=$CURRENT_DIR
Environment=PATH=$CURRENT_DIR/weather_env/bin
ExecStart=$CURRENT_DIR/weather_env/bin/python $CURRENT_DIR/main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

        # Reload systemd and enable service
        sudo systemctl daemon-reload
        sudo systemctl enable weather-monitor.service

        print_status "Systemd slu≈æba nakonfigurov√°na"
        print_info "Pro spu≈°tƒõn√≠: sudo systemctl start weather-monitor"
        print_info "Pro zastaven√≠: sudo systemctl stop weather-monitor"
        print_info "Pro status: sudo systemctl status weather-monitor"
    fi
fi

# Step 8: Final configuration
echo ""
echo "üéØ Krok 8: Fin√°ln√≠ nastaven√≠"
echo "============================"

# Create main.py if it doesn't exist
if [[ ! -f "main.py" ]]; then
    cat > main.py << 'EOF'
#!/usr/bin/env python3
"""
Main entry point for Weather Storm Detection System
"""

import asyncio
import sys
import os

# Add current directory to Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from scheduler import main

if __name__ == "__main__":
    print("üå©Ô∏è Starting Weather Storm Detection System...")
    asyncio.run(main())
EOF

    chmod +x main.py
    print_status "main.py vytvo≈ôen"
fi

# Create start script
cat > start.sh << 'EOF'
#!/bin/bash

# Weather Storm Detection System - Start Script

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd "$SCRIPT_DIR"

echo "üå©Ô∏è Spou≈°t√≠m Weather Storm Detection System..."

# Activate virtual environment
source weather_env/bin/activate

# Check if .env exists
if [[ ! -f .env ]]; then
    echo "‚ùå Soubor .env nenalezen! Spus≈•te nejprve setup.sh"
    exit 1
fi

# Start the system
python3 main.py
EOF

chmod +x start.sh

# Create stop script
cat > stop.sh << 'EOF'
#!/bin/bash

# Weather Storm Detection System - Stop Script

echo "üõë Zastavuji Weather Storm Detection System..."

# Kill any running instances
pkill -f "python.*main.py"

# If systemd service exists, stop it
if systemctl is-active --quiet weather-monitor; then
    sudo systemctl stop weather-monitor
    echo "‚úÖ Systemd slu≈æba zastavena"
fi

echo "‚úÖ Syst√©m zastaven"
EOF

chmod +x stop.sh

# Create update script
cat > update.sh << 'EOF'
#!/bin/bash

# Weather Storm Detection System - Update Script

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd "$SCRIPT_DIR"

echo "üîÑ Aktualizuji Weather Storm Detection System..."

# Activate virtual environment
source weather_env/bin/activate

# Update Python packages
pip install --upgrade -r requirements.txt

# Restart service if running
if systemctl is-active --quiet weather-monitor; then
    sudo systemctl restart weather-monitor
    echo "‚úÖ Slu≈æba restartov√°na"
fi

echo "‚úÖ Syst√©m aktualizov√°n"
EOF

chmod +x update.sh

print_status "Skripty pro spr√°vu vytvo≈ôeny"

# Step 9: Quick test
echo ""
echo "üöÄ Krok 9: Z√°vƒõreƒçn√Ω test"
echo "========================"

print_info "Spou≈°t√≠m rychl√Ω test konfigurace..."
if python3 -c "
from config import load_config
config = load_config()
print('‚úÖ Konfigurace v po≈ô√°dku')
print(f'üìç Lokace: {config.weather.city_name}, {config.weather.region}')
print(f'üìß Email: {config.email.sender_email} -> {config.email.recipient_email}')
print(f'üîë API kl√≠ƒçe: OpenWeather={\"‚úì\" if config.weather.openweather_api_key else \"‚úó\"}, Visual Crossing={\"‚úì\" if config.weather.visual_crossing_api_key else \"‚úó\"}, DeepSeek={\"‚úì\" if config.ai.deepseek_api_key else \"‚úó\"}')
"; then
    print_status "Konfigurace ovƒõ≈ôena"
else
    print_error "Probl√©m s konfigurac√≠!"
    exit 1
fi

# Final summary
echo ""
echo "üéâ INSTALACE DOKONƒåENA!"
echo "======================"
echo ""
print_status "Weather Storm Detection System je p≈ôipraven k pou≈æit√≠!"
echo ""
echo "üìã P≈ôehled soubor≈Ø:"
echo "   üîß setup.sh      - Tento instalaƒçn√≠ script"
echo "   üöÄ start.sh      - Spu≈°tƒõn√≠ syst√©mu"
echo "   üõë stop.sh       - Zastaven√≠ syst√©mu"
echo "   üîÑ update.sh     - Aktualizace syst√©mu"
echo "   ‚öôÔ∏è  .env          - Konfigurace (NEMAZAT!)"
echo "   üìä main.py       - Hlavn√≠ spou≈°tƒõc√≠ soubor"
echo ""
echo "üöÄ Jak spustit:"
echo "   Manu√°lnƒõ:     ./start.sh"
if [[ "$OS" == "linux" && $AUTO_START =~ ^[Yy]$ ]]; then
echo "   Jako slu≈æba:  sudo systemctl start weather-monitor"
fi
echo ""
echo "üìß Syst√©m bude:"
echo "   üîÑ Ka≈æd√Ωch 10 minut kontrolovat poƒças√≠"
echo "   üåÖ Ka≈æd√Ω den v 9:00 poslat shrnut√≠ s AI obsahem"
echo "   ‚ö° Poslat varov√°n√≠ p≈ôi detekci bou≈ôe (AI + ƒåHM√ö data)"
echo "   üèõÔ∏è Kontrolovat ofici√°ln√≠ ƒåHM√ö varov√°n√≠"
echo ""
echo "üìù Logy najdete v:"
echo "   üìÅ logs/          - Aplikaƒçn√≠ logy"
echo "   üìÅ reports/       - PDF reporty"
if [[ "$OS" == "linux" ]]; then
echo "   üìã journalctl -u weather-monitor -f  - Systemd logy"
fi
echo ""
print_info "Pro spu≈°tƒõn√≠ test≈Ø: python3 test_system.py"
print_info "Pro pokroƒçil√© testy: python3 test_combined_system.py"
echo ""
print_warning "D≈ÆLE≈ΩIT√â: Soubor .env obsahuje citliv√© √∫daje - nemazat a nesd√≠let!"
echo ""
echo "üéØ Syst√©m je p≈ôipraven detekovat bou≈ôe a pos√≠lat chytr√° varov√°n√≠!"
echo "   Pou≈æ√≠v√° AI anal√Ωzu kombinovanou s ofici√°ln√≠mi ƒåHM√ö daty"
echo "   Pos√≠l√° pouze vysoce spolehliv√° varov√°n√≠ (>99% jistota)"
echo "   Denn√≠ shrnut√≠ generovan√© AI v ƒçe≈°tinƒõ"
echo ""
print_status "Instalace √∫spƒõ≈°nƒõ dokonƒçena! üå©Ô∏è"
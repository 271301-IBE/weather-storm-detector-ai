<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Weather Storm Detection{% endblock %}</title>
    <meta name="theme-color" content="#0ea5b1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link href="{{ asset_url('favicon.ico') }}" rel="icon" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        /* Theme variables (light by default) */
        :root {
            --bg: #f0f2f5;
            --text: #1a1c22;
            --muted: #6b7280;
            --card: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --accent: #22d3ee;
            --link: #0ea5b1;
            --link-hover: #0b8894;

            --sidebar-bg: #2c3e50;
            --sidebar-link: #bdc3c7;
            --sidebar-link-active-bg: #34495e;
            --sidebar-link-active-text: #ffffff;

            --table-stripe: rgba(0, 0, 0, 0.02);
        }

        /* Dark theme overrides */
        body.dark-mode {
            --bg: #0f1115;
            --text: #e6e6e6;
            --muted: #a3a3a3;
            --card: #171a21;
            --border: #252a33;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
            --accent: #22d3ee;
            --link: #22d3ee;
            --link-hover: #19b8d0;

            --sidebar-bg: #0f131a;
            --sidebar-link: #c9d1d9;
            --sidebar-link-active-bg: #1c232e;
            --sidebar-link-active-text: #e6e6e6;

            --table-stripe: rgba(255, 255, 255, 0.04);
        }

        /* Base layout */
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            transition: background-color 180ms ease, color 180ms ease;
            color-scheme: light dark;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background-color: var(--sidebar-bg);
            padding-top: 20px;
            color: var(--sidebar-link-active-text);
            transition: background-color 180ms ease, color 180ms ease;
        }
        .sidebar a {
            padding: 15px 20px;
            text-decoration: none;
            font-size: 18px;
            color: var(--sidebar-link);
            display: block;
            transition: background-color 150ms ease, color 150ms ease;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: var(--sidebar-link-active-bg);
            color: var(--sidebar-link-active-text);
        }
        .sidebar .nav-link i { margin-right: 10px; }
        .content {
            margin-left: 250px;
            padding: 20px;
            transition: background-color 180ms ease, color 180ms ease;
        }
        .navbar { display: none; } /* Hide top navbar, sidebar replaces it */
        .card-header .badge { font-weight: 500; }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; }
        .history-chart-container { height: 280px; }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease-in-out, background-color 180ms ease, border-color 180ms ease, color 180ms ease, box-shadow 180ms ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card-header {
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text);
            padding: 1rem 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            transition: background-color 180ms ease, border-color 180ms ease, color 180ms ease;
        }

        .list-group-item {
            background-color: var(--card);
            color: var(--text);
            border-color: var(--border);
        }

        .table { color: var(--text); }
        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-stripe);
        }
        .text-muted { color: var(--muted) !important; }

        a { color: var(--link); }
        a:hover, a:focus { color: var(--link-hover); }

        /* Make light badges readable in dark mode */
        body.dark-mode .badge.bg-light { 
            background-color: #2a2f3a !important; 
            color: #e6e6e6 !important; 
            border: 1px solid var(--border);
        }
        body.dark-mode .badge.bg-secondary { color: #e6e6e6; }
        canvas { background: transparent; }

        /* Dark mode overrides for common Bootstrap utility classes */
        body.dark-mode .text-dark { color: var(--text) !important; }
        body.dark-mode .text-black { color: var(--text) !important; }
        body.dark-mode .bg-white { background-color: var(--card) !important; color: var(--text) !important; }
        body.dark-mode .bg-light { background-color: #1c232e !important; color: var(--text) !important; }
        body.dark-mode .table { color: var(--text) !important; }
        body.dark-mode .table thead th { color: var(--text) !important; border-color: var(--border) !important; }
        body.dark-mode .table td, 
        body.dark-mode .table th { border-color: var(--border) !important; }

        /* Balanced tables utilities */
        .table-balanced {
            font-variant-numeric: tabular-nums; /* monospaced numerals for alignment */
        }
        .table-balanced th,
        .table-balanced td {
            vertical-align: middle;
            border-color: var(--border);
        }
        .table-balanced thead th {
            border-bottom: 1px solid var(--border);
        }
        .table-balanced tbody tr:hover {
            background-color: rgba(14,165,177,0.06);
        }
        .table-sticky thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background-color: var(--card);
        }
        .nowrap { white-space: nowrap; }
        .col-w-xxs { width: 64px; }
        .col-w-xs { width: 88px; }
        .col-w-sm { width: 120px; }
        .col-w-md { width: 160px; }
        .col-w-lg { width: 220px; }

        /* Buttons tweaks for dark background readability */
        .btn-outline-light { border-color: var(--border); color: var(--text); }
        .btn-outline-light:hover { background: var(--sidebar-link-active-bg); color: var(--sidebar-link-active-text); }

        .btn-outline-info { color: #0ea5b1; border-color: #0ea5b1; }
        .btn-outline-info:hover { background: #0ea5b1; color: #ffffff; }

        /* Chart containers */
        .chart-container { height: 340px; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { left: -250px; transition: left 0.3s; }
            .sidebar.active { left: 0; }
            .content { margin-left: 0; }
            .navbar-toggler { display: block; }
            .content { padding: 12px; }
            .card:hover { transform: none; }
            .history-chart-container { height: 220px; }
            .chart-container { height: 240px; }
            /* Make tables scrollable horizontally on small screens */
            .table { display: block; overflow-x: auto; white-space: nowrap; }
            /* Larger tap targets */
            .btn, .form-control { min-height: 44px; }
            .list-group-item { flex-wrap: wrap; gap: 6px; }
            /* Tabs scroll instead of wrapping */
            .nav-tabs { overflow-x: auto; flex-wrap: nowrap; }
            .nav-tabs .nav-link { white-space: nowrap; }
        }

        /* Sidebar backdrop for mobile */
        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            z-index: 1030;
            display: none;
        }
        .sidebar.active + .sidebar-backdrop { display: block; }
    </style>
    {% block head %}{% endblock %}
    <style>
        .online-status {
            position: fixed;
            right: 12px;
            bottom: 12px;
            z-index: 1050;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .online-status.online { display: inline-block; background: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .online-status.offline { display: inline-block; background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light d-md-none">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" aria-label="Open menu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="#">üå©Ô∏è Weather AI</a>
        </div>
    </nav>

    <div class="sidebar">
        <h4 class="text-center mb-4">üå©Ô∏è Weather AI</h4>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/"><i class="bi bi-grid-fill"></i>Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/#snow"><i class="bi bi-snow"></i>SNOW</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/map' %}active{% endif %}" href="/map"><i class="bi bi-lightning-charge-fill"></i>Lightning Map</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/history' %}active{% endif %}" href="/history"><i class="bi bi-clock-history"></i>History</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/system_info' %}active{% endif %}" href="/system_info"><i class="bi bi-info-circle-fill"></i>System Info</a>
            </li>
        </ul>
        <div class="position-absolute bottom-0 w-100 p-3">
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="darkModeSwitch" aria-label="Toggle dark mode">
                <label class="form-check-label" for="darkModeSwitch">
                    <span id="themeLabel">Dark Mode</span>
                    <i id="themeIcon" class="bi bi-moon-stars ms-1"></i>
                </label>
            </div>
            <button class="btn btn-outline-info w-100 mb-2" id="enableNotifications">Enable Notifications</button>
            <a href="/logout" class="btn btn-outline-light w-100">Logout</a>
            <div class="text-center mt-2 text-muted small" id="lastUpdate">Loading...</div>
        </div>
    </div>
    <div class="sidebar-backdrop d-md-none" role="button" aria-label="Close menu"></div>

    <div class="content">
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <div id="netStatus" class="online-status" aria-live="polite"></div>
    <script>
        // Wrap all DOM interactions to fire after full load and guard null elements
        window.addEventListener('load', () => {
            // Theme Manager: controls dark/light mode, persists state, notifies charts and maps
            const body = document.body;
            const THEME_KEY = 'darkMode'; // 'enabled' | null

            function setTheme(dark) {
                const currentlyDark = body.classList.contains('dark-mode');
                if (dark && !currentlyDark) {
                    body.classList.add('dark-mode');
                    try { localStorage.setItem(THEME_KEY, 'enabled'); } catch(_) {}
                } else if (!dark && currentlyDark) {
                    body.classList.remove('dark-mode');
                    try { localStorage.removeItem(THEME_KEY); } catch(_) {}
                }
                // Notify listeners (charts, map)
                window.dispatchEvent(new CustomEvent('themechange', { detail: { dark } }));
            }

            // Initialize from storage
            (function initTheme() {
                let dark = false;
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    dark = saved === 'enabled';
                } catch(_) {}
                if (dark) body.classList.add('dark-mode');
                const themeIcon = document.getElementById('themeIcon');
                const themeLabel = document.getElementById('themeLabel');
                if (themeIcon) themeIcon.className = dark ? 'bi bi-moon-stars ms-1' : 'bi bi-sun ms-1';
                if (themeLabel) themeLabel.textContent = dark ? 'Dark Mode' : 'Light Mode';
                // notify so components can sync
                window.dispatchEvent(new CustomEvent('themechange', { detail: { dark } }));
            })();

            // Toggle binding
            const darkModeSwitch = document.getElementById('darkModeSwitch');
            if (darkModeSwitch) {
                // reflect initial state
                darkModeSwitch.checked = document.body.classList.contains('dark-mode');
                darkModeSwitch.addEventListener('change', () => setTheme(darkModeSwitch.checked));
            }

            // Navbar sidebar toggle (mobile)
            const navToggler = document.querySelector('.navbar-toggler');
            const sidebar = document.querySelector('.sidebar');
            const sidebarBackdrop = document.querySelector('.sidebar-backdrop');
            if (navToggler && sidebar) {
                navToggler.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
            if (sidebarBackdrop && sidebar) {
                sidebarBackdrop.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                });
            }
            // Close sidebar when a link is clicked (mobile UX)
            const sidebarLinks = document.querySelectorAll('.sidebar .nav-link');
            sidebarLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    if (sidebar && window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });

            // Simple online/offline indicator
            const netStatus = document.getElementById('netStatus');
            function updateOnlineStatus() {
                if (!netStatus) return;
                if (navigator.onLine) {
                    netStatus.textContent = 'Online';
                    netStatus.className = 'online-status online';
                } else {
                    netStatus.textContent = 'Offline';
                    netStatus.className = 'online-status offline';
                }
                if (navigator.onLine) {
                    setTimeout(() => {
                        if (navigator.onLine) netStatus.className = 'online-status';
                    }, 2500);
                }
            }
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            // Register Service Worker (idempotent, safe for local)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }

            // Chart.js dark mode support (if charts are present and globally accessible)
            window.addEventListener('themechange', (e) => {
                const isDark = !!(e.detail && e.detail.dark);
                const charts = (window.appCharts && Array.isArray(window.appCharts)) ? window.appCharts : [];
                charts.forEach((chart) => {
                    try {
                        // Axes & grid
                        if (chart.options && chart.options.scales) {
                            for (const key of Object.keys(chart.options.scales)) {
                                const scale = chart.options.scales[key];
                                if (!scale) continue;
                                if (!scale.ticks) scale.ticks = {};
                                if (!scale.grid) scale.grid = {};
                                scale.ticks.color = isDark ? '#e6e6e6' : '#1a1c22';
                                scale.grid.color = isDark ? 'rgba(230,230,230,0.08)' : 'rgba(26,28,34,0.08)';
                                scale.grid.borderColor = isDark ? 'rgba(230,230,230,0.2)' : 'rgba(26,28,34,0.2)';
                            }
                        }
                        // Plugins
                        if (!chart.options) chart.options = {};
                        if (!chart.options.plugins) chart.options.plugins = {};
                        if (!chart.options.plugins.legend) chart.options.plugins.legend = {};
                        if (!chart.options.plugins.tooltip) chart.options.plugins.tooltip = {};
                        chart.options.plugins.legend.labels = { color: isDark ? '#e6e6e6' : '#1a1c22' };
                        chart.options.plugins.tooltip = {
                            backgroundColor: isDark ? 'rgba(23,26,33,0.92)' : 'rgba(255,255,255,0.95)',
                            titleColor: isDark ? '#e6e6e6' : '#1a1c22',
                            bodyColor: isDark ? '#e6e6e6' : '#1a1c22',
                            borderColor: isDark ? '#252a33' : '#e5e7eb',
                            borderWidth: 1
                        };
                        // Title
                        if (!chart.options.plugins.title) chart.options.plugins.title = {};
                        chart.options.plugins.title.color = isDark ? '#e6e6e6' : '#1a1c22';

                        // Dataset defaults (optional subtle tweak)
                        if (chart.data && Array.isArray(chart.data.datasets)) {
                            chart.data.datasets.forEach(ds => {
                                if (ds.borderColor == null) ds.borderColor = isDark ? '#22d3ee' : '#0ea5b1';
                                if (ds.backgroundColor == null) ds.backgroundColor = isDark ? 'rgba(34,211,238,0.15)' : 'rgba(14,165,177,0.15)';
                            });
                        }

                        chart.update && chart.update('none');
                    } catch (_) { /* ignore per-chart issues */ }
                });
            });

            // Map dark mode support hooks (to be used by lightning_map.html initialization script)
            // The map code can listen to 'themechange' and swap tile layers accordingly.
            // Example in map script:
            // window.addEventListener('themechange', ({detail:{dark}}) => setMapTheme(dark));
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

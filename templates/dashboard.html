<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Storm Detection - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5; /* Light gray background */
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .navbar {
            background-color: #2c3e50 !important; /* Darker blue-gray for navbar */
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            border: none;
            border-radius: 0.75rem; /* Slightly more rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            margin-bottom: 1.5rem; /* Spacing between cards */
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
        }
        .card-header {
            background-color: #ffffff; /* White header background */
            border-bottom: 1px solid #e0e0e0; /* Light border */
            font-weight: bold;
            color: #34495e; /* Darker text for headers */
            padding: 1rem 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .list-group-item {
            border-color: #f0f2f5; /* Lighter border for list items */
        }
        .badge {
            font-size: 0.85em;
            padding: 0.4em 0.7em;
        }
        .text-danger {
            color: #e74c3c !important; /* Stronger red */
        }
        .text-warning {
            color: #f39c12 !important; /* Stronger orange */
        }
        .text-success {
            color: #28a745 !important; /* Standard green */
        }
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #664d03;
        }
        .alert-danger {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .alert-info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .alert-primary {
            background-color: #cfe2ff;
            border-color: #0d6efd;
            color: #052c65;
        }
        .alert-secondary {
            background-color: #e2e3e5;
            border-color: #6c757d;
            color: #383d41;
        }
        .alert-light {
            background-color: #fefefe;
            border-color: #fdfdfe;
            color: #818182;
        }
        .alert-dark {
            background-color: #d3d3d4;
            border-color: #343a40;
            color: #1b1e21;
        }
        #weatherChart {
            height: 400px; /* Make chart taller */
        }
        #liveLogsContainer {
            background-color: #333;
            color: #0f0;
            font-family: 'monospace';
            padding: 15px;
            border-radius: 0.5rem;
            height: 500px;
            overflow-y: scroll;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">üå©Ô∏è Weather Storm Detection</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#dashboard" onclick="showTab('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#live-logs" onclick="showTab('live-logs')">Live Logs</a>
                    </li>
                </ul>
                <span class="navbar-text me-3" id="lastUpdate">Loading...</span>
                <a href="/logout" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div id="dashboard-content">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">Current Weather üå§Ô∏è</div>
                        <div class="card-body" id="currentWeather">
                            <p class="text-center">Loading weather data...</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">System Stats (24h) üìä</div>
                        <div class="card-body" id="systemStats">
                            <p class="text-center">Loading statistics...</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">Recent AI Analysis ü§ñ</div>
                        <div class="card-body" id="recentAnalysis">
                            <p class="text-center">Loading analysis data...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">Weather Trends (24h) üìà</div>
                        <div class="card-body">
                            <canvas id="weatherChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">API Usage Stats üîó</div>
                        <div class="card-body" id="apiUsageStats">
                            <p class="text-center">Loading API usage...</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">Combined Weather Data ‚öñÔ∏è</div>
                        <div class="card-body" id="weatherAverages">
                            <p class="text-center">Loading averages...</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">ƒåHM√ö Varov√°n√≠ - Brno ‚ö†Ô∏è</div>
                        <div class="card-body" id="chmiWarnings">
                            <p class="text-center">Loading warnings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="live-logs-content" style="display:none;">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">Live Logs üìú</div>
                        <div class="card-body">
                            <pre id="liveLogsContainer">Loading logs...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let weatherChart;
        let eventSource;
        
        // Auto-refresh data every 30 seconds
        setInterval(loadAllData, 30000);
        
        // Load all data on page load
        window.onload = function() {
            loadAllData();
            showTab('dashboard'); // Default to dashboard tab
        };
        
        function showTab(tabId) {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('live-logs-content').style.display = 'none';

            document.querySelector('.nav-link.active').classList.remove('active');

            if (tabId === 'dashboard') {
                document.getElementById('dashboard-content').style.display = 'block';
                document.querySelector('a[href="#dashboard"]').classList.add('active');
                if (eventSource) {
                    eventSource.close(); // Close log stream if switching away
                }
            } else if (tabId === 'live-logs') {
                document.getElementById('live-logs-content').style.display = 'block';
                document.querySelector('a[href="#live-logs"]').classList.add('active');
                loadLiveLogs();
            }
        }

        function loadAllData() {
            loadCurrentWeather();
            loadSystemStats();
            loadRecentAnalysis();
            loadWeatherChart();
            loadApiUsageStats();
            loadWeatherAverages();
            loadChmiWarnings();
            updateLastUpdateTime();
        }
        
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();
        }
        
        function loadCurrentWeather() {
            fetch('/api/current_weather')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('currentWeather');
                    if (data.length > 0) {
                        const latest = data[0];
                        container.innerHTML = `
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Temperature
                                    <span class="badge bg-primary rounded-pill">${latest.temperature?.toFixed(1) || 'N/A'}¬∞C</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Humidity
                                    <span class="badge bg-primary rounded-pill">${latest.humidity?.toFixed(0) || 'N/A'}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Pressure
                                    <span class="badge bg-primary rounded-pill">${latest.pressure?.toFixed(0) || 'N/A'} hPa</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Wind Speed
                                    <span class="badge bg-primary rounded-pill">${latest.wind_speed?.toFixed(1) || 'N/A'} m/s</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Precipitation
                                    <span class="badge bg-primary rounded-pill">${latest.precipitation?.toFixed(1) || 'N/A'} mm</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Source
                                    <span class="badge bg-secondary rounded-pill">${latest.source || 'N/A'}</span>
                                </li>
                            </ul>
                        `;
                    } else {
                        container.innerHTML = '<p class="text-center">No weather data available</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('currentWeather').innerHTML = '<p class="text-center text-danger">Error loading weather data</p>';
                    console.error('Error:', error);
                });
        }
        
        function loadSystemStats() {
            fetch('/api/system_stats')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('systemStats');
                    container.innerHTML = `
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Weather Data Points
                                <span class="badge bg-primary rounded-pill">${data.weather_data_24h || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                AI Analyses
                                <span class="badge bg-primary rounded-pill">${data.ai_analysis_24h || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Emails Sent
                                <span class="badge bg-primary rounded-pill">${data.emails_24h || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Storms Detected (7d)
                                <span class="badge bg-primary rounded-pill">${data.storms_detected_7d || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Avg Confidence (7d)
                                <span class="badge bg-primary rounded-pill">${data.avg_confidence_7d || 0}%</span>
                            </li>
                        </ul>
                    `;
                })
                .catch(error => {
                    document.getElementById('systemStats').innerHTML = '<p class="text-center text-danger">Error loading statistics</p>';
                    console.error('Error:', error);
                });
        }
        
        function loadRecentAnalysis() {
            fetch('/api/recent_analysis')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentAnalysis');
                    if (data.length > 0) {
                        container.innerHTML = data.slice(0, 5).map(analysis => {
                            const confidence = (analysis.confidence_score * 100).toFixed(1);
                            const confidenceClass = confidence > 80 ? 'text-danger' :
                                                  confidence > 50 ? 'text-warning' : 'text-success';
                            const timestamp = new Date(analysis.timestamp).toLocaleString();
                            
                            return `
                                <div class="list-group-item">
                                    <strong>${analysis.storm_detected ? '‚ö° Storm Detected' : '‚úÖ Normal Conditions'}</strong>
                                    <span class="float-end ${confidenceClass}">${confidence}%</span>
                                    <div class="text-muted small">${timestamp} - Alert: ${analysis.alert_level}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<p class="text-center">No analysis data available</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('recentAnalysis').innerHTML = '<p class="text-center text-danger">Error loading analysis data</p>';
                    console.error('Error:', error);
                });
        }
        
        function loadWeatherChart() {
            fetch('/api/weather_history?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('weatherChart').getContext('2d').clearRect(0, 0, document.getElementById('weatherChart').width, document.getElementById('weatherChart').height);
                        if (weatherChart) weatherChart.destroy();
                        return;
                    }
                    
                    const ctx = document.getElementById('weatherChart').getContext('2d');
                    
                    const openweatherData = data.filter(d => d.source === 'openweather');
                    const visualcrossingData = data.filter(d => d.source === 'visual_crossing');
                    const tomorrowioData = data.filter(d => d.source === 'tomorrow_io');
                    
                    if (weatherChart) {
                        weatherChart.destroy();
                    }
                    
                    weatherChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: 'Temperature (¬∞C) - OpenWeather',
                                    data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    tension: 0.3,
                                    fill: false,
                                    yAxisID: 'y-temp'
                                },
                                {
                                    label: 'Temperature (¬∞C) - Visual Crossing',
                                    data: visualcrossingData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.3,
                                    fill: false,
                                    yAxisID: 'y-temp'
                                },
                                {
                                    label: 'Temperature (¬∞C) - Tomorrow.io',
                                    data: tomorrowioData.map(d => ({ x: new Date(d.timestamp), y: d.temperature })),
                                    borderColor: 'rgba(255, 206, 86, 1)',
                                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                    tension: 0.3,
                                    fill: false,
                                    yAxisID: 'y-temp'
                                },
                                {
                                    label: 'Wind Speed (m/s) - OpenWeather',
                                    data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.wind_speed })),
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.3,
                                    fill: false,
                                    yAxisID: 'y-wind'
                                },
                                {
                                    label: 'Humidity (%) - OpenWeather',
                                    data: openweatherData.map(d => ({ x: new Date(d.timestamp), y: d.humidity })),
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    tension: 0.3,
                                    fill: false,
                                    yAxisID: 'y-humidity'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'hour',
                                        displayFormats: {
                                            hour: 'HH:mm'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                'y-temp': {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Temperature (¬∞C)'
                                    },
                                    grid: {
                                        drawOnChartArea: true,
                                    },
                                },
                                'y-wind': {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Wind Speed (m/s)'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                    // Offset this axis slightly if it overlaps with y-humidity
                                    // offset: true 
                                },
                                'y-humidity': {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Humidity (%)'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                    // Ensure this axis is distinct from y-wind if both are on the right
                                    // You might need to adjust `offset` or `position` more carefully
                                    // For now, let's assume they won't overlap too badly or one will be primary
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading weather chart:', error);
                    document.getElementById('weatherChart').getContext('2d').clearRect(0, 0, document.getElementById('weatherChart').width, document.getElementById('weatherChart').height);
                    if (weatherChart) weatherChart.destroy();
                });
        }
        
        function loadApiUsageStats() {
            fetch('/api/api_usage_stats')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('apiUsageStats');
                    let html = '<ul class="list-group list-group-flush">';
                    
                    html += '<li class="list-group-item list-group-item-info"><strong>24h API vol√°n√≠:</strong></li>';
                    if (data.usage_24h && Object.keys(data.usage_24h).length > 0) {
                        Object.entries(data.usage_24h).forEach(([source, count]) => {
                            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${source}
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </li>`;
                        });
                    } else {
                        html += '<li class="list-group-item">≈Ω√°dn√° data za posledn√≠ch 24h</li>';
                    }
                    
                    html += '</ul>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading API usage stats:', error);
                    document.getElementById('apiUsageStats').innerHTML = '<p class="text-center text-danger">Error loading API usage data</p>';
                });
        }
        
        function loadWeatherAverages() {
            fetch('/api/weather_averages')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('weatherAverages');
                    
                    if (data.source_count > 0) {
                        container.innerHTML = `
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Pr≈Ømƒõr teplota
                                    <span class="badge bg-primary rounded-pill">${data.temperature?.toFixed(1) || 'N/A'}¬∞C</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Pr≈Ømƒõr vlhkost
                                    <span class="badge bg-primary rounded-pill">${data.humidity?.toFixed(0) || 'N/A'}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Pr≈Ømƒõr tlak
                                    <span class="badge bg-primary rounded-pill">${data.pressure?.toFixed(0) || 'N/A'} hPa</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Pr≈Ømƒõr v√≠tr
                                    <span class="badge bg-primary rounded-pill">${data.wind_speed?.toFixed(1) || 'N/A'} m/s</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Sr√°≈æky pravdƒõp.
                                    <span class="badge bg-primary rounded-pill">${data.precipitation_probability?.toFixed(0) || 'N/A'}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    API zdroj≈Ø
                                    <span class="badge bg-secondary rounded-pill">${data.source_count}</span>
                                </li>
                            </ul>
                        `;
                    } else {
                        container.innerHTML = '<p class="text-center">≈Ω√°dn√° aktu√°ln√≠ data k dispozici</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading weather averages:', error);
                    document.getElementById('weatherAverages').innerHTML = '<p class="text-center text-danger">Error loading average data</p>';
                });
        }
        
        function loadChmiWarnings() {
            fetch('/api/chmi_warnings')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('chmiWarnings');
                    
                    if (data.warnings && data.warnings.length > 0) {
                        let html = `<div class="alert alert-warning">
                            <strong>Aktivn√≠ch varov√°n√≠: ${data.total_warnings}</strong>
                            ${data.storm_warnings > 0 ? `<br><span class="text-danger">Bou≈ôkov√° varov√°n√≠: ${data.storm_warnings}</span>` : ''}
                        </div>`;
                        
                        data.warnings.forEach(warning => {
                            // Map ƒåHM√ö colors to Bootstrap alert classes
                            let alertClass = 'alert-info'; // Default
                            switch (warning.color) {
                                case 'green': alertClass = 'alert-success'; break;
                                case 'yellow': alertClass = 'alert-warning'; break;
                                case 'orange': alertClass = 'alert-danger'; break; // Orange often treated as severe
                                case 'red': alertClass = 'alert-danger'; break;
                            }

                            const startTime = warning.time_start ? new Date(warning.time_start).toLocaleString('cs-CZ') : 'Neuvedeno';
                            const endTime = warning.time_end ? new Date(warning.time_end).toLocaleString('cs-CZ') : 'Neuvedeno';
                            
                            html += `<div class="alert ${alertClass}">
                                <h5 class="alert-heading">${warning.event}</h5>
                                <p>${warning.description || 'Bez popisu'}</p>
                                <hr>
                                <p class="mb-0">Od: ${startTime} Do: ${endTime}</p>
                            </div>`;
                        });
                        
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `<div class="alert alert-success">
                            ‚úÖ ≈Ω√°dn√° aktivn√≠ varov√°n√≠ pro Brno
                        </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading ƒåHM√ö warnings:', error);
                    document.getElementById('chmiWarnings').innerHTML = '<p class="text-center text-danger">Error loading ƒåHM√ö warnings</p>';
                });
        }

        function loadLiveLogs() {
            const logContainer = document.getElementById('liveLogsContainer');
            logContainer.innerHTML = ''; // Clear previous logs

            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/api/live_logs');

            eventSource.onmessage = function(event) {
                const newLogEntry = document.createElement('div');
                newLogEntry.textContent = event.data;
                logContainer.appendChild(newLogEntry);
                logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom
            };

            eventSource.onerror = function(err) {
                console.error('EventSource failed:', err);
                eventSource.close();
                logContainer.innerHTML += '\n<span style="color: red;">Error connecting to log stream. Please refresh the page.</span>';
            };
        }
    </script>
</body>
</html>